in updateAnalytics:', error);
            }
        }
        
        // Calcola statistiche
        function calcolaStatistiche(contratti) {
            const validi = contratti.filter(c => !c.stornato);
            const stornati = contratti.filter(c => c.stornato);
            
            return {
                totaleContratti: validi.reduce((sum, c) => sum + c.numeroContratti, 0),
                totaleValore: validi.reduce((sum, c) => sum + c.prezzo, 0),
                online: validi.filter(c => c.prodotto === 'ON LINE').length,
                virtual: validi.filter(c => c.prodotto === 'VIRTUAL').length,
                stornati: stornati.length,
                valoreStornati: stornati.reduce((sum, c) => sum + c.prezzo, 0)
            };
        }
        
        // Genera tabella comparativa
        function generaTabellaComparativa(contratti1, contratti2, dal1, al1, dal2, al2, label1, label2) {
            try {
                const stats1 = calcolaStatistiche(contratti1);
                const stats2 = calcolaStatistiche(contratti2);
                
                const mediaValore1 = stats1.totaleContratti > 0 ? stats1.totaleValore / stats1.totaleContratti : 0;
                const mediaValore2 = stats2.totaleContratti > 0 ? stats2.totaleValore / stats2.totaleContratti : 0;
                
                const diffContratti = stats2.totaleContratti - stats1.totaleContratti;
                const percDiffContratti = stats1.totaleContratti > 0 ? (diffContratti / stats1.totaleContratti * 100) : 0;
                
                const diffValore = stats2.totaleValore - stats1.totaleValore;
                const percDiffValore = stats1.totaleValore > 0 ? (diffValore / stats1.totaleValore * 100) : 0;
                
                const diffStornati = stats2.stornati - stats1.stornati;
                
                const tableBody = document.getElementById('comparisonTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td>Numero Contratti Validi</td>
                        <td style="text-align: center;">${stats1.totaleContratti}</td>
                        <td style="text-align: center;">${stats2.totaleContratti}</td>
                        <td style="text-align: center; font-weight: bold; color: ${diffContratti >= 0 ? '#28a745' : '#dc3545'}">
                            ${diffContratti >= 0 ? '+' : ''}${diffContratti} (${percDiffContratti >= 0 ? '+' : ''}${percDiffContratti.toFixed(1)}%)
                        </td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td>Valore Totale</td>
                        <td style="text-align: center;">€ ${stats1.totaleValore.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: center;">€ ${stats2.totaleValore.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: center; font-weight: bold; color: ${diffValore >= 0 ? '#28a745' : '#dc3545'}">
                            ${diffValore >= 0 ? '+' : ''}€ ${diffValore.toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                            (${percDiffValore >= 0 ? '+' : ''}${percDiffValore.toFixed(1)}%)
                        </td>
                    </tr>
                    <tr>
                        <td>Valore Medio Contratto</td>
                        <td style="text-align: center;">€ ${mediaValore1.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: center;">€ ${mediaValore2.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: center; font-weight: bold; color: ${mediaValore2 >= mediaValore1 ? '#28a745' : '#dc3545'}">
                            ${mediaValore2 >= mediaValore1 ? '+' : ''}€ ${(mediaValore2 - mediaValore1).toLocaleString('it-IT', {minimumFractionDigits: 2})}
                        </td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td>Contratti Stornati</td>
                        <td style="text-align: center;">${stats1.stornati}</td>
                        <td style="text-align: center;">${stats2.stornati}</td>
                        <td style="text-align: center; font-weight: bold; color: ${diffStornati <= 0 ? '#28a745' : '#dc3545'}">
                            ${diffStornati >= 0 ? '+' : ''}${diffStornati}
                        </td>
                    </tr>
                    <tr>
                        <td>Valore Stornati</td>
                        <td style="text-align: center;">€ ${stats1.valoreStornati.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: center;">€ ${stats2.valoreStornati.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: center; font-weight: bold; color: ${stats2.valoreStornati <= stats1.valoreStornati ? '#28a745' : '#dc3545'}">
                            ${stats2.valoreStornati >= stats1.valoreStornati ? '+' : ''}€ ${(stats2.valoreStornati - stats1.valoreStornati).toLocaleString('it-IT', {minimumFractionDigits: 2})}
                        </td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td>Prodotti ON LINE</td>
                        <td style="text-align: center;">${stats1.online}</td>
                        <td style="text-align: center;">${stats2.online}</td>
                        <td style="text-align: center; font-weight: bold; color: ${stats2.online >= stats1.online ? '#28a745' : '#dc3545'}">
                            ${stats2.online >= stats1.online ? '+' : ''}${stats2.online - stats1.online}
                        </td>
                    </tr>
                    <tr>
                        <td>Prodotti VIRTUAL</td>
                        <td style="text-align: center;">${stats1.virtual}</td>
                        <td style="text-align: center;">${stats2.virtual}</td>
                        <td style="text-align: center; font-weight: bold; color: ${stats2.virtual >= stats1.virtual ? '#28a745' : '#dc3545'}">
                            ${stats2.virtual >= stats1.virtual ? '+' : ''}${stats2.virtual - stats1.virtual}
                        </td>
                    </tr>
                `;
            } catch (error) {
                console.error('Errore in generaTabellaComparativa:', error);
            }
        }

        // Esporta dati
        function exportData() {
            try {
                let csv = 'Mese Produzione;Data Ingresso;Data Ordine;Venditore;Prodotto;Nome;Cognome;Prezzo;Rateizzazione;Num Contratti;';
                csv += 'Incasso Gen;Incasso Feb;Incasso Mar;Incasso Apr;Incasso Mag;Incasso Giu;';
                csv += 'Incasso Lug;Incasso Ago;Incasso Set;Incasso Ott;Incasso Nov;Incasso Dic\n';
                
                const mesi = ['gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
                             'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'];
                
                contracts.forEach(c => {
                    csv += `${c.meseProduzione};${c.dataIngresso};${c.dataOrdine};${c.venditore};${c.prodotto};`;
                    csv += `${c.nomeStudente};${c.cognomeStudente};${c.prezzo};${c.rateizzazione};${c.numeroContratti};`;
                    
                    mesi.forEach(mese => {
                        csv += `${c.incassi && c.incassi[mese] ? c.incassi[mese] : ''};`;
                    });
                    csv += '\n';
                });

                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `contratti_pronto_diploma_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                showNotification('📥 Export completato!');
            } catch (error) {
                console.error('Errore in exportData:', error);
            }
        }

        // Funzioni per importazione Excel (le stesse del codice originale ma con Firebase)
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').style.background = '#f0f0f0';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').style.background = 'white';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').style.background = 'white';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processExcelFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        function processExcelFile(file) {
            // [Il codice di processamento Excel rimane lo stesso]
            // ...
        }

        function showImportPreview(data, filename) {
            // [Il codice di preview rimane lo stesso]
            // ...
        }

        async function confirmImport() {
            try {
                let importedCount = 0;
                let skippedCount = 0;
                
                updateSyncIndicator('syncing');
                
                // Aggiungi venditori nuovi
                const existingVenditori = venditori.map(v => v.nome);
                const newVenditori = [...new Set(tempImportData.map(c => c.venditore))];
                
                for (const nome of newVenditori) {
                    if (!existingVenditori.includes(nome)) {
                        await database.ref('venditori').push({
                            nome: nome,
                            attivo: true,
                            timestamp: Date.now()
                        });
                    }
                }
                
                // Importa contratti
                for (const contractData of tempImportData) {
                    const isDuplicate = contracts.some(c => 
                        c.nomeStudente === contractData.nomeStudente &&
                        c.cognomeStudente === contractData.cognomeStudente &&
                        c.meseProduzione === contractData.meseProduzione &&
                        c.prezzo === contractData.prezzo
                    );
                    
                    if (!isDuplicate) {
                        await database.ref('contracts').push({
                            ...contractData,
                            timestamp: Date.now()
                        });
                        importedCount++;
                    } else {
                        skippedCount++;
                    }
                }
                
                // Mostra risultati
                const resultsDiv = document.getElementById('importResults');
                const statsDiv = document.getElementById('importStats');
                
                statsDiv.innerHTML = `
                    <p>✅ <strong>Contratti importati:</strong> ${importedCount}</p>
                    ${skippedCount > 0 ? `<p>⚠️ <strong>Contratti saltati (duplicati):</strong> ${skippedCount}</p>` : ''}
                    <p>📊 <strong>Totale contratti nel sistema:</strong> ${contracts.length + importedCount}</p>
                `;
                
                resultsDiv.style.display = 'block';
                document.getElementById('importPreview').style.display = 'none';
                
                document.getElementById('excelFile').value = '';
                tempImportData = [];
                
                showNotification(`✅ Importati ${importedCount} contratti!`);
                updateSyncIndicator('synced');
                
            } catch (error) {
                alert('❌ Errore durante l\'importazione: ' + error.message);
                console.error(error);
                updateSyncIndicator('offline');
            }
        }

        function cancelImport() {
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('excelFile').value = '';
            tempImportData = [];
        }

        // Inizializza all'avvio
        window.onload = function() {
            try {
                const dataIngresso = document.getElementById('dataIngresso');
                const dataOrdine = document.getElementById('dataOrdine');
                
                if (dataIngresso) dataIngresso.valueAsDate = new Date();
                if (dataOrdine) dataOrdine.valueAsDate = new Date();
                
                initializeFilters();
            } catch (error) {
                console.error('Errore in window.onload:', error);
            }
        };
    </script>
</body>
</html>
