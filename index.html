<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronto Diploma - Gestione Contratti v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 6px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 500;
            color: #6c757d;
            transition: .3s;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover { color: #495057; }

        .tab.active { color: #667eea; }
        .tab.active::after { content:''; position:absolute; bottom:-2px; left:0; right:0; height:3px; background:#667eea; }

        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn .3s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px }
        .form-group { display:flex; flex-direction:column }
        .form-group label { font-weight:600; margin-bottom:8px; color:#495057; font-size:.9em }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:8px; font-size:1em; transition:.3s }
        .form-group input:focus, .form-group select:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1) }

        .btn { padding:12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border:none; border-radius:8px; font-size:1em; font-weight:600; cursor:pointer; transition:.3s }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,.3) }
        .btn:disabled { opacity:.5; cursor: not-allowed }
        .btn-secondary { background:#6c757d }
        .btn-danger { background:#dc3545 }
        .btn-success { background:#28a745 }

        table { width:100%; border-collapse:collapse; margin-top:20px }
        th { background:#f8f9fa; padding:12px; text-align:left; font-weight:600; color:#495057; border-bottom:2px solid #e9ecef }
        td { padding:12px; border-bottom:1px solid #e9ecef }
        tr:hover { background:#f8f9fa }
        .actions { display:flex; gap:10px }
        .btn-small { padding:6px 12px; font-size:.85em }

        .notification { position:fixed; top:20px; right:20px; background:#4ade80; color:#fff; padding:16px 24px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.2); animation:slideIn .3s; z-index:1000 }
        @keyframes slideIn { from { transform:translateX(400px) } to { transform:translateX(0) } }

        .search-section { background:#e8f4fd; border:2px solid #0066cc; border-radius:12px; padding:20px; margin-bottom:25px }
        .search-grid { display:grid; grid-template-columns:1fr 1fr auto; gap:15px; align-items:end }
        .search-results { margin-top:15px; max-height:200px; overflow-y:auto; background:#fff; border-radius:8px; padding:10px; display:none }
        .search-result-item { padding:10px; border-bottom:1px solid #e9ecef; cursor:pointer; transition:.3s }
        .search-result-item:hover { background:#f8f9fa }

        .month-filter { display:flex; gap:10px; margin-bottom:20px; align-items:center; flex-wrap:wrap }
        .export-btn { margin-left:auto }

        .incassi-section { background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:20px }
        .incassi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; margin-top:15px }

        .venditori-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; margin:20px 0 }
        .venditore-card { background:#fff; border:2px solid #e9ecef; border-radius:8px; padding:15px; display:flex; justify-content:space-between; align-items:center; transition:.3s }
        .venditore-card:hover{ border-color:#667eea; transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,.2) }
        .venditore-name { font-weight:600; color:#495057 }

        /* Login */
        .login-container { position:fixed; inset:0; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; justify-content:center; align-items:center; z-index:10000 }
        .login-box { background:#fff; padding:40px; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.3); width:400px; max-width:90% }
        .login-header { text-align:center; margin-bottom:30px }
        .login-header h1 { color:#667eea; font-size:2em; margin-bottom:10px }
        .login-header p { color:#6c757d }
        .login-error { color:#dc3545; text-align:center; margin-top:15px; display:none }
    </style>
</head>
<body>

  <!-- Login (resta locale; opzionale) -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <h1>üéì Pronto Diploma</h1>
        <p>Sistema di Gestione Contratti</p>
      </div>
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="userId">ID Utente</label>
          <input type="text" id="userId" required autocomplete="username"/>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autocomplete="current-password"/>
        </div>
        <button type="submit" class="btn">Accedi</button>
        <div id="loginError" class="login-error">ID o password non validi</div>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="mainContainer" class="container" style="display:none;">
    <div class="header">
      <h1>üéì Pronto Diploma</h1>
      <p>Sistema di Gestione Contratti e Report</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="inserimento">üìù Inserimento</button>
      <button class="tab" data-tab="venditori">üë• Venditori</button>
      <button class="tab" data-tab="contratti">üìã Contratti</button>
      <button class="tab" data-tab="importa">üì§ Importa Excel</button>
      <button class="tab" data-tab="report">üìä Report</button>
    </div>

    <div class="content">
      <!-- Inserimento -->
      <div id="inserimento" class="tab-content active">
        <h2 style="margin-bottom:20px;">Nuovo Contratto</h2>

        <div class="search-section">
          <h3>üîç Ricerca Studente Esistente</h3>
          <div class="search-grid">
            <input type="text" id="searchNome" placeholder="Cerca per nome...">
            <input type="text" id="searchCognome" placeholder="Cerca per cognome...">
            <button class="btn btn-secondary" id="clearSearchBtn" type="button">Pulisci</button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </div>

        <form id="contractForm">
          <div class="form-grid">
            <div class="form-group">
              <label>Mese Produzione *</label>
              <select id="meseProduzione" required></select>
            </div>
            <div class="form-group">
              <label>Data Ingresso Lead *</label>
              <input type="date" id="dataIngresso" required>
            </div>
            <div class="form-group">
              <label>Data Ordine *</label>
              <input type="date" id="dataOrdine" required>
            </div>
            <div class="form-group">
              <label>Venditore *</label>
              <select id="venditore" required></select>
            </div>
            <div class="form-group">
              <label>Prodotto *</label>
              <select id="prodotto" required>
                <option value="">Seleziona...</option>
                <option value="ON LINE">ON LINE</option>
                <option value="VIRTUAL">VIRTUAL</option>
              </select>
            </div>
            <div class="form-group">
              <label>Nome Studente *</label>
              <input type="text" id="nomeStudente" required>
            </div>
            <div class="form-group">
              <label>Cognome Studente *</label>
              <input type="text" id="cognomeStudente" required>
            </div>
            <div class="form-group">
              <label>Prezzo (‚Ç¨) *</label>
              <input type="number" step="0.01" id="prezzo" required>
            </div>
            <div class="form-group">
              <label>Tipo Rateizzazione</label>
              <select id="rateizzazione">
                <option value="Bonifico">Bonifico</option>
                <option value="Link To Pay">Link To Pay</option>
                <option value="Banca Sella Prestito al Consumo">Banca Sella Prestito al Consumo</option>
                <option value="Rateizzazione Interna">Rateizzazione Interna</option>
                <option value="Scalapay">Scalapay</option>
                <option value="Acconto + Link To Pay">Acconto + Link To Pay</option>
                <option value="Acconto + Banca Sella">Acconto + Banca Sella Prestito al Consumo</option>
              </select>
            </div>
            <div class="form-group">
              <label>Numero Contratti</label>
              <input type="number" id="numeroContratti" value="1" min="1">
            </div>
          </div>

          <div class="incassi-section">
            <h3>üí∞ Incassi Mensili</h3>
            <p style="margin-top:10px;color:#6c757d;">Inserisci gli importi previsti per ogni mese (lascia vuoto se non previsto)</p>
            <div class="incassi-grid" id="incassiGrid"></div>
          </div>

          <button type="submit" class="btn" id="saveBtn">‚úÖ Salva Contratto</button>
        </form>
      </div>

      <!-- Venditori -->
      <div id="venditori" class="tab-content">
        <h2 style="margin-bottom:20px;">Gestione Venditori</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
          <input type="text" id="nuovoVenditore" placeholder="Nome nuovo venditore" maxlength="50" style="flex:1;min-width:200px;padding:12px;border:2px solid #e9ecef;border-radius:8px">
          <button class="btn btn-success" id="addVenditoreBtn" type="button">‚ûï Aggiungi Venditore</button>
        </div>
        <h3 style="margin-bottom:15px;">Venditori Attivi</h3>
        <div id="venditoriList" class="venditori-list"></div>
      </div>

      <!-- Contratti -->
      <div id="contratti" class="tab-content">
        <div class="month-filter">
          <h2>Elenco Contratti</h2>
          <select id="filterMonth">
            <option value="">Tutti i mesi</option>
            <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
            <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
            <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
            <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
          </select>
          <select id="filterYear">
            <option value="">Tutti gli anni</option>
            <option>2024</option><option selected>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option>
          </select>
          <select id="filterVenditore"><option value="">Tutti i venditori</option></select>
          <button class="btn btn-secondary export-btn" id="exportBtn" type="button">üì• Esporta Excel</button>
        </div>
        <div id="contractsList"></div>
      </div>

      <!-- Importa -->
      <div id="importa" class="tab-content">
        <h2>Importazione File Excel</h2>
        <div style="background:#e7f3ff;border:2px solid #0066cc;border-radius:12px;padding:20px;margin:20px 0;">
          <h3 style="color:#0066cc;margin-bottom:15px;">üìã Formato File Excel Richiesto</h3>
          <ol style="margin-left:20px;line-height:1.8">
            <li><strong>INGRESSO LEAD</strong> (AAAA-MM-GG)</li>
            <li><strong>Data ordine</strong> (AAAA-MM-GG)</li>
            <li><strong>SALES</strong></li>
            <li><strong>Prodotto</strong> (ON LINE / VIRTUAL)</li>
            <li><strong>Membro / Referente</strong> (Nome e Cognome)</li>
            <li><strong>Prezzo</strong> (numero)</li>
            <li><strong>Rateizzato</strong></li>
            <li><strong>N CTR</strong></li>
            <li><strong>INCASSO [MESE]</strong> (Gennaio‚Ä¶Dicembre)</li>
          </ol>
        </div>
        <div style="background:#fff;border:2px dashed #ddd;border-radius:12px;padding:40px;text-align:center;margin:20px 0;">
          <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
          <div id="dropZone">
            <div style="font-size:48px;color:#667eea;margin-bottom:20px">üìÅ</div>
            <h3 style="margin-bottom:15px;">Trascina qui il file Excel</h3>
            <p style="color:#666;margin-bottom:20px;">oppure</p>
            <button class="btn" id="selectFileBtn" type="button">Seleziona File</button>
          </div>
        </div>
        <div id="importPreview" style="display:none">
          <h3 style="margin:20px 0;">Anteprima Dati</h3>
          <div id="previewInfo" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;"></div>
          <div style="max-height:400px;overflow-y:auto">
            <table id="previewTable" style="font-size:.9em;"></table>
          </div>
          <div style="margin-top:20px;display:flex;gap:10px">
            <button class="btn btn-success" id="confirmImportBtn" type="button">‚úÖ Conferma Importazione</button>
            <button class="btn btn-secondary" id="cancelImportBtn" type="button">‚ùå Annulla</button>
          </div>
        </div>
        <div id="importResults" style="display:none;margin-top:20px;">
          <div style="background:#d4edda;border:1px solid #c3e6cb;border-radius:8px;padding:15px;">
            <h4 style="color:#155724;margin-bottom:10px;">‚úÖ Importazione Completata</h4>
            <div id="importStats"></div>
          </div>
        </div>
      </div>

      <!-- Report -->
      <div id="report" class="tab-content">
        <h2>Dashboard Report</h2>
        <div class="month-filter" style="margin-bottom:25px;">
          <select id="reportFilterMonth">
            <option value="">Seleziona mese...</option>
            <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
            <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
            <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
            <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
          </select>
          <select id="reportFilterYear">
            <option>2024</option><option selected>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option>
          </select>
          <select id="reportFilterVenditore"><option value="">Tutti i venditori</option></select>
        </div>
        <div id="dashboardSummary" style="display:none">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">
            <div class="stat-card"><h3>Contratti del Mese</h3><div class="value" id="dashTotContratti">0</div></div>
            <div class="stat-card"><h3>Incasso del Mese</h3><div class="value" id="dashIncassoMese">‚Ç¨ 0,00</div></div>
            <div class="stat-card"><h3>Ricavo Totale Mese</h3><div class="value" id="dashRicavoMese">‚Ç¨ 0,00</div></div>
            <div class="stat-card" style="background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);">
              <h3>Contratti Stornati</h3><div class="value" id="dashStornati">0</div>
              <div style="font-size:.9em;margin-top:5px;">Valore: <span id="dashValoreStornati">‚Ç¨ 0</span></div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%);">
              <h3>Prodotti</h3>
              <div style="font-size:1.1em;margin-top:10px;">
                <div style="margin-bottom:8px;">üì± Online: <strong id="dashOnline">0</strong></div>
                <div>üíª Virtual: <strong id="dashVirtual">0</strong></div>
              </div>
            </div>
          </div>
        </div>
        <div id="dashboardNoData" style="text-align:center;padding:40px;background:#f8f9fa;border-radius:12px;margin-bottom:30px;">
          <p style="color:#6c757d;font-size:1.1em;">Seleziona un mese per visualizzare la dashboard e il report dettagliato</p>
        </div>
        <div id="reportContent"></div>
      </div>
    </div>
  </div>

  <!-- Dipendenze -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Script applicativo v2.1 (logica UI: tabs, render, report, import, ecc.) -->
  <script>
    // --- Stato UI e mock auth locale ---
    var currentUser = null;
    var users = {
      'Amministrazione': { password: 'prontodiploma', permissions: ['inserimento','venditori','contratti'] },
      'Gianluca Madeddu': { password: 'sono1975', permissions: ['inserimento','venditori','contratti','importa','report'] }
    };
    function $(s){ return document.querySelector(s); }
    function $$(s){ return document.querySelectorAll(s); }
    function showNotification(msg){
      var n = document.createElement('div'); n.className='notification'; n.textContent=msg;
      document.body.appendChild(n); setTimeout(function(){ n.remove(); }, 3000);
    }

    // --- Inizializza select mesi e griglia incassi ---
    function initMeseProduzione(){
      var sel=$('#meseProduzione'); if(!sel) return; sel.innerHTML='';
      var months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      var d=new Date(), curY=d.getFullYear(), curM=d.getMonth()+1;
      var opt0=document.createElement('option'); opt0.value=''; opt0.textContent='Seleziona...'; sel.appendChild(opt0);
      for(var y=2024;y<=2030;y++){
        months.forEach(function(m,idx){
          var v=y+'-'+String(idx+1).padStart(2,'0');
          var o=document.createElement('option'); o.value=v; o.textContent=m+' '+y;
          if(y===curY && (idx+1)===curM) o.selected=true; sel.appendChild(o);
        });
      }
      var di=$('#dataIngresso'); var dof=$('#dataOrdine');
      if(di) di.valueAsDate=new Date(); if(dof) dof.valueAsDate=new Date();
    }
    function initIncassiGrid(){
      var grid=$('#incassiGrid'); if(!grid) return; grid.innerHTML='';
      var mesi=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      mesi.forEach(function(m){
        var wrap=document.createElement('div'); wrap.className='incasso-month';
        wrap.innerHTML='<label>'+m+'</label><input type="number" step="0.01" id="incasso'+m+'" placeholder="0.00">';
        grid.appendChild(wrap);
      });
    }

    // --- Login locale ---
    $('#loginForm').addEventListener('submit', function(e){
      e.preventDefault();
      var id=$('#userId').value.trim(); var pwd=$('#password').value.trim();
      if(users[id] && users[id].password===pwd){
        currentUser={ id:id, permissions:users[id].permissions };
        $('#loginContainer').style.display='none';
        $('#mainContainer').style.display='block';
        setupTabs(); initMeseProduzione(); initIncassiGrid();
        showNotification('Benvenuto!');
      } else { $('#loginError').style.display='block'; $('#password').value=''; }
    });

    function setupTabs(){
      $$('.tab').forEach(function(btn){
        var name=btn.dataset.tab;
        if(!currentUser.permissions.includes(name)) btn.style.display='none';
        btn.addEventListener('click', function(){
          $$('.tab').forEach(function(b){b.classList.remove('active')}); btn.classList.add('active');
          $$('.tab-content').forEach(function(c){c.classList.remove('active')});
          $('#'+name).classList.add('active');
          if(name==='contratti') loadContracts();
          if(name==='report') updateDashboard();
        });
      });
      var first=currentUser.permissions[0];
      var firstBtn=document.querySelector('.tab[data-tab="'+first+'"]'); if(firstBtn) firstBtn.click();
    }

    // --- Dati in memoria (verranno hydrati da Firebase) ---
    window.venditori = [];
    window.contracts = [];

    // --- Ricerca studenti ---
    function clearSearch(){ $('#searchNome').value=''; $('#searchCognome').value=''; $('#searchResults').style.display='none'; }
    $('#clearSearchBtn').addEventListener('click',clearSearch);
    async function searchStudents(){
      var nome = ($('#searchNome').value||'').toLowerCase();
      var cogn = ($('#searchCognome').value||'').toLowerCase();
      var resultsDiv = $('#searchResults');
      if(!nome && !cogn){ resultsDiv.style.display='none'; return; }
      var all = (window.contracts||[]);
      var filtered = all.filter(function(c){
        var m1 = nome ? (c.nomeStudente||'').toLowerCase().includes(nome) : true;
        var m2 = cogn ? (c.cognomeStudente||'').toLowerCase().includes(cogn) : true;
        return m1 && m2;
      }).slice(0,50);
      if(filtered.length){
        resultsDiv.innerHTML = filtered.map(function(c){
          return '<div class="search-result-item" data-pick="'+c.nomeStudente+'|||'+c.cognomeStudente+'">\
            <strong>'+c.nomeStudente+' '+c.cognomeStudente+'</strong> - '+(c.prodotto||'')+' - ‚Ç¨'+Number(c.prezzo||0).toFixed(2)+' - '+(c.dataOrdine?new Date(c.dataOrdine).toLocaleDateString('it-IT'):'-')+'\
          </div>';
        }).join('');
      } else {
        resultsDiv.innerHTML = '<div style="padding:10px;color:#6c757d;">Nessuno studente trovato</div>';
      }
      resultsDiv.style.display='block';
      resultsDiv.querySelectorAll('[data-pick]').forEach(function(el){
        el.addEventListener('click', function(){
          var parts = el.getAttribute('data-pick').split('|||');
          $('#nomeStudente').value = parts[0] || ''; $('#cognomeStudente').value = parts[1] || '';
          clearSearch();
        });
      });
    }
    $('#searchNome').addEventListener('keyup',searchStudents);
    $('#searchCognome').addEventListener('keyup',searchStudents);

    // --- Render contratti con filtri ---
    async function loadContracts(){
      var m = $('#filterMonth').value; var y=$('#filterYear').value; var v=$('#filterVenditore').value;
      var listEl=$('#contractsList'); listEl.innerHTML='<p style="padding:20px;color:#6c757d;">Caricamento...</p>';
      var all = (window.contracts||[]).map(function(c){ return c; });
      if(m || y){
        all = all.filter(function(c){
          if(!c.meseProduzione) return false;
          var parts=c.meseProduzione.split('-');
          var yy=parts[0], mm=parts[1];
          var okM = m ? Number(mm)===Number(m) : true;
          var okY = y ? String(yy)===String(y) : true;
          return okM && okY;
        });
      }
      if(v) all = all.filter(function(c){ return String(c.venditore)===String(v); });
      all.sort(function(a,b){ return new Date(b.dataOrdine) - new Date(a.dataOrdine); });
      if(all.length===0){ listEl.innerHTML='<p style="text-align:center;padding:40px;color:#6c757d;">Nessun contratto trovato</p>'; return; }
      var monthNames=['','Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
      var rows = all.map(function(c){
        var totInc = Object.values(c.incassi||{}).reduce(function(s,val){ return s+Number(val||0) },0);
        var meseTxt='-';
        if(c.meseProduzione){
          var parts=c.meseProduzione.split('-'); var yy=parts[0], mm=parts[1];
          meseTxt = monthNames[parseInt(mm)]+' '+yy;
        }
        return '\
          <tr>\
            <td><strong>'+meseTxt+'</strong></td>\
            <td>'+(c.dataOrdine?new Date(c.dataOrdine).toLocaleDateString('it-IT'):'-')+'</td>\
            <td>'+(c.venditore||'')+'</td>\
            <td>'+(c.nomeStudente||'')+' '+(c.cognomeStudente||'')+'</td>\
            <td><span style="background:'+(c.prodotto==='ON LINE'?'#667eea':'#764ba2')+';color:#fff;padding:2px 8px;border-radius:4px">'+(c.prodotto||'')+'</span></td>\
            <td>‚Ç¨ '+Number(c.prezzo||0).toFixed(2)+'</td>\
            <td style="font-size:.9em">'+(c.rateizzazione||'')+'</td>\
            <td>'+Number(c.numeroContratti||1)+'</td>\
            <td>‚Ç¨ '+totInc.toFixed(2)+'</td>\
            <td class="actions">'+(c.stornato?'<span style="color:#dc3545;font-weight:bold;">STORNATO</span>':'<button class="btn btn-secondary btn-small" onclick="stornaContract('+c.id+')">‚ö†Ô∏è</button>')+'\
                <button class="btn btn-danger btn-small" onclick="deleteContract('+c.id+')">üóëÔ∏è</button></td>\
          </tr>';
      }).join('');
      listEl.innerHTML = '\
        <table>\
          <thead>\
            <tr>\
              <th>Mese Prod.</th><th>Data Ordine</th><th>Venditore</th><th>Studente</th>\
              <th>Prodotto</th><th>Prezzo</th><th>Rateizzazione</th><th>N¬∞ CTR</th><th>Incassi Tot.</th><th>Azioni</th>\
            </tr>\
          </thead>\
          <tbody>'+rows+'</tbody>\
        </table>\
        <p style="margin-top:20px;color:#6c757d;">Totale contratti: '+all.length+'</p>';
    }
    $('#filterMonth').addEventListener('change',loadContracts);
    $('#filterYear').addEventListener('change',loadContracts);
    $('#filterVenditore').addEventListener('change',loadContracts);

    // --- Export CSV ---
    $('#exportBtn').addEventListener('click', function(){
      var all = (window.contracts||[]);
      if(!all.length){ alert('Nessun dato da esportare'); return; }
      var headers = ['id','meseProduzione','dataIngresso','dataOrdine','venditore','prodotto','nomeStudente','cognomeStudente','prezzo','rateizzazione','numeroContratti','stornato','incassi_json'];
      var lines = [headers.join(';')];
      all.forEach(function(c){
        var row = [
          c.id||'', c.meseProduzione||'', c.dataIngresso||'', c.dataOrdine||'', c.venditore||'', c.prodotto||'',
          c.nomeStudente||'', c.cognomeStudente||'', (c.prezzo??''), c.rateizzazione||'', (c.numeroContratti??''), (c.stornato?1:0), JSON.stringify(c.incassi||{})
        ].map(function(v){ return String(v).replace(/;/g,',') });
        lines.push(row.join(';'));
      });
      var blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      var url = URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download='contratti_export_'+Date.now()+'.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // --- Report ---
    function updateDashboard(){
      var month=parseInt($('#reportFilterMonth').value);
      var year =parseInt($('#reportFilterYear').value);
      var vend = $('#reportFilterVenditore').value;
      if(!month){ $('#dashboardSummary').style.display='none'; $('#dashboardNoData').style.display='block'; $('#reportContent').innerHTML=''; return; }
      $('#dashboardSummary').style.display='block'; $('#dashboardNoData').style.display='none';

      var all = (window.contracts||[]);
      var allFiltered = all.filter(function(c){
        if(!c.meseProduzione) return false;
        var parts=c.meseProduzione.split('-'); var y=parts[0], m=parts[1];
        var ok = parseInt(m)===month && parseInt(y)===year;
        return ok && (!vend || c.venditore===vend);
      });
      var valid = allFiltered.filter(function(c){ return !c.stornato });
      var storn = allFiltered.filter(function(c){ return c.stornato });
      var monthNames=['','gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
      var mKey = monthNames[month];

      var totContr=0, incassoMese=0, ricavoTot=0, online=0, virtual=0;
      valid.forEach(function(c){
        totContr += Number(c.numeroContratti||1);
        ricavoTot += Number(c.prezzo||0);
        incassoMese += c.incassi && c.incassi[mKey] ? Number(c.incassi[mKey]) : 0;
        if(c.prodotto==='ON LINE') online++; else if(c.prodotto==='VIRTUAL') virtual++;
      });
      var totSt=0, valSt=0; storn.forEach(function(c){ totSt += Number(c.numeroContratti||1); valSt += Number(c.prezzo||0); });
      $('#dashTotContratti').textContent=totContr;
      $('#dashIncassoMese').textContent='‚Ç¨ '+incassoMese.toLocaleString('it-IT',{minimumFractionDigits:2});
      $('#dashRicavoMese').textContent='‚Ç¨ '+ricavoTot.toLocaleString('it-IT',{minimumFractionDigits:2});
      $('#dashOnline').textContent=online; $('#dashVirtual').textContent=virtual; $('#dashStornati').textContent=totSt; $('#dashValoreStornati').textContent='‚Ç¨ '+valSt.toLocaleString('it-IT',{minimumFractionDigits:2});

      var perVend = {};
      valid.forEach(function(c){
        if(!perVend[c.venditore]) perVend[c.venditore]={contr:0,incasso:0,ricavo:0,online:0,virtual:0};
        perVend[c.venditore].contr += Number(c.numeroContratti||1);
        perVend[c.venditore].ricavo += Number(c.prezzo||0);
        perVend[c.venditore].incasso += c.incassi && c.incassi[mKey]?Number(c.incassi[mKey]):0;
        if(c.prodotto==='ON LINE') perVend[c.venditore].online++; else if(c.prodotto==='VIRTUAL') perVend[c.venditore].virtual++;
      });
      var monthNamesFull=['','Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      var rows = Object.entries(perVend).sort(function(a,b){ return b[1].ricavo - a[1].ricavo; }).map(function(entry,idx){
        var nome=entry[0], data=entry[1];
        var perc = data.ricavo?((data.incasso/data.ricavo)*100):0; var medal = idx===0?'ü•á ':idx===1?'ü•à ':idx===2?'ü•â ':'';
        return '\
          <tr style="'+(idx<3?'background:#fffbf0;':'')+'">\
            <td><strong>'+medal+nome+'</strong></td>\
            <td>'+data.contr+'</td>\
            <td>‚Ç¨ '+data.incasso.toLocaleString('it-IT',{minimumFractionDigits:2})+'</td>\
            <td>‚Ç¨ '+data.ricavo.toLocaleString('it-IT',{minimumFractionDigits:2})+'</td>\
            <td>‚Ç¨ '+(data.contr? (data.incasso/data.contr):0).toLocaleString('it-IT',{minimumFractionDigits:2})+'</td>\
            <td>‚Ç¨ '+(data.contr? (data.ricavo/data.contr):0).toLocaleString('it-IT',{minimumFractionDigits:2})+'</td>\
            <td><strong>'+perc.toFixed(2)+'%</strong></td>\
            <td>'+data.online+'/'+data.virtual+'</td>\
          </tr>';
      }).join('');
      $('#reportContent').innerHTML = '\
        <div style="margin-top:30px;">\
          <h3 style="margin-bottom:20px;">üìä Report Dettaglio Venditori - '+monthNamesFull[month]+' '+year+'</h3>\
          <table>\
            <thead>\
              <tr>\
                <th>Venditore</th><th>N¬∞ Contratti</th><th>Incasso '+monthNamesFull[month]+'</th><th>Ricavo Totale</th>\
                <th>Media Incasso</th><th>Media/Contratto</th><th>% Incasso</th><th>Online/Virtual</th>\
              </tr>\
            </thead>\
            <tbody>'+(rows || '<tr><td colspan="8" style="text-align:center;color:#6c757d">Nessun dato</td></tr>')+'</tbody>\
          </table>\
        </div>';
    }
    $('#reportFilterMonth').addEventListener('change',updateDashboard);
    $('#reportFilterYear').addEventListener('change',updateDashboard);
    $('#reportFilterVenditore').addEventListener('change',updateDashboard);

    // --- Import Excel (SheetJS) ---
    var dropZone = $('#dropZone'); var fileInput = $('#excelFile');
    $('#selectFileBtn').addEventListener('click', function(){ fileInput.click(); });
    fileInput.addEventListener('change', handleFile);
    dropZone.addEventListener('dragover', function(e){ e.preventDefault(); dropZone.style.opacity='.8' });
    dropZone.addEventListener('dragleave', function(){ dropZone.style.opacity='1' });
    dropZone.addEventListener('drop', function(e){ e.preventDefault(); dropZone.style.opacity='1'; if(e.dataTransfer.files && e.dataTransfer.files[0]) parseExcel(e.dataTransfer.files[0]); });

    function handleFile(e){ var f=e.target.files && e.target.files[0]; if(f) parseExcel(f); }
    function parseExcel(file){
      var reader = new FileReader();
      reader.onload = function(e){
        var data = new Uint8Array(e.target.result);
        var wb = XLSX.read(data,{type:'array'});
        var sheetName = wb.SheetNames[0];
        var ws = wb.Sheets[sheetName];
        var json = XLSX.utils.sheet_to_json(ws,{defval:''});
        window.tempImportData = transformExcelJson(json, sheetName);
        $('#importPreview').style.display='block';
        $('#previewInfo').innerHTML = '<strong>Foglio:</strong> '+sheetName+' ‚Ä¢ <strong>Righe:</strong> '+json.length;
        var headers = Object.keys(json[0]||{});
        var thead = '<thead><tr>'+headers.map(function(h){return '<th>'+h+'</th>'}).join('')+'</tr></thead>';
        var tbody = '<tbody>'+json.slice(0,50).map(function(r){return '<tr>'+headers.map(function(h){return '<td>'+String(r[h])+'</td>'}).join('')+'</tr>'}).join('')+'</tbody>';
        $('#previewTable').innerHTML = thead+tbody;
      };
      reader.readAsArrayBuffer(file);
    }

    function transformExcelJson(rows, sheetName){
      var out = [];
      var mesiMap = {Gennaio:'gennaio',Febbraio:'febbraio',Marzo:'marzo',Aprile:'aprile',Maggio:'maggio',Giugno:'giugno',Luglio:'luglio',Agosto:'agosto',Settembre:'settembre',Ottobre:'ottobre',Novembre:'novembre',Dicembre:'dicembre'};
      rows.forEach(function(row){
        // Estrai nome/cognome dal campo "Membro / Referente"
        var nc = String(row['Membro / Referente']||' ').trim().split(' ');
        var nome = nc.slice(0,-1).join(' ') || nc[0] || '';
        var cogn = nc.slice(-1).join(' ') || '';
        // Date normalizzate
        var dataIngresso = row['INGRESSO LEAD'] || '';
        var dataOrdine   = row['Data ordine'] || '';
        if (dataIngresso && /\d{1,2}\/\d{1,2}\/\d{2,4}/.test(dataIngresso)) {
          var p = dataIngresso.split('/'); dataIngresso = p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0');
        }
        if (dataOrdine && /\d{1,2}\/\d{1,2}\/\d{2,4}/.test(dataOrdine)) {
          var q = dataOrdine.split('/'); dataOrdine = q[2]+'-'+q[1].padStart(2,'0')+'-'+q[0].padStart(2,'0');
        }
        var incassi = {};
        Object.keys(mesiMap).forEach(function(k){
          var v = parseFloat(String(row['INCASSO '+k]||'').replace(',', '.')) || 0;
          if (v>0) incassi[mesiMap[k]] = v;
        });
        var venditore = String(row['SALES']||'').toUpperCase();
        var prodotto  = String(row['Prodotto']||'');
        var prezzo    = parseFloat(String(row['Prezzo']||'').replace(',', '.')) || 0;
        var rateizzato= String(row['Rateizzato']||'') || 'Bonifico';
        var nCtr      = parseInt(row['N CTR']||'1');
        var d=new Date(); var meseProduzione=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        out.push({
          meseProduzione: meseProduzione,
          dataIngresso: dataIngresso,
          dataOrdine:   dataOrdine,
          venditore: venditore,
          prodotto: prodotto,
          nomeStudente: nome,
          cognomeStudente: cogn,
          prezzo: prezzo,
          rateizzazione: rateizzato,
          numeroContratti: nCtr,
          incassi: incassi,
          stornato:false,
          timestamp: Date.now()
        });
      });
      return out;
    }

    $('#confirmImportBtn').addEventListener('click', function(){ if (typeof window.confirmImport === 'function') window.confirmImport(); });
    $('#cancelImportBtn').addEventListener('click', function(){ window.tempImportData=[]; $('#importPreview').style.display='none'; $('#previewTable').innerHTML=''; var file = $('#excelFile'); if (file) file.value = ''; });
    $('#selectFileBtn').addEventListener('click', function(){ $('#excelFile').click(); });

    // Aggiungi venditore (delegato a override Firebase)
    $('#addVenditoreBtn').addEventListener('click', function(){ if (typeof window.aggiungiVenditore === 'function') window.aggiungiVenditore(); });

    // Submit contratto: la persistenza su Firebase √® nell'override; qui validiamo UI
    $('#contractForm').addEventListener('submit', function(e){
      e.preventDefault();
      var required = ['meseProduzione','dataIngresso','dataOrdine','venditore','prodotto','nomeStudente','cognomeStudente','prezzo'];
      for (var i=0;i<required.length;i++){
        var el = document.getElementById(required[i]);
        if (!el || !el.value) { alert('Compila tutti i campi obbligatori'); return; }
      }
      showNotification('‚úÖ Salvataggio in corso...');
      // L'override Firebase intercetta e persiste; poi l'hydrate aggiorna le liste.
      // Per UX, resettiamo i campi.
      setTimeout(function(){
        $('#contractForm').reset();
        initMeseProduzione();
      }, 250);
    });

  </script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>

  <!-- Integrazione Firebase: hydrate arrays v2.1 + override salvataggi -->
  <script>
  (function(){
    // Config fornita
    var firebaseConfig = {
      apiKey: "AIzaSyAKAs06_n8t19KH5CxMGisxZGM1Q5kpiU0",
      authDomain: "pronto-diploma.firebaseapp.com",
      databaseURL: "https://pronto-diploma-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "pronto-diploma",
      storageBucket: "pronto-diploma.firebasestorage.app",
      messagingSenderId: "640164355453",
      appId: "1:640164355453:web:7c79a591af4869c54f4014"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // Mappe chiavi Firebase <-> ID locali
    var FB = window.__fb = {
      contractKeyByLocalId: new Map(),
      venditoreKeyByName: new Map()
    };

    function normalizeIncassi(inc) {
      inc = inc || {};
      var out = {};
      Object.keys(inc).forEach(function(k){
        var v = Number(inc[k] || 0);
        if (!isNaN(v) && v > 0) out[String(k).toLowerCase()] = v;
      });
      return out;
    }
    function notify(msg){
      if (typeof window.showNotification === 'function') return window.showNotification(msg);
      try { var n = document.createElement('div'); n.style.cssText = "position:fixed;top:20px;right:20px;background:#4ade80;color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:99999"; n.textContent = msg; document.body.appendChild(n); setTimeout(function(){ n.remove(); }, 2500); } catch(e){}
    }

    // Realtime: VENDITORI
    firebase.database().ref('venditori').on('value', function(snap){
      FB.venditoreKeyByName.clear(); window.venditori = [];
      var data = snap.val() || {}; var id = 1;
      Object.keys(data).forEach(function(key){
        var v = data[key] || {}; var attivo = v.attivo !== false; var nome = String(v.nome || '').toUpperCase(); if (!nome) return;
        window.venditori.push({ id: id++, nome: nome, attivo: attivo }); FB.venditoreKeyByName.set(nome, key);
      });
      if (typeof window.updateVenditoriSelect === 'function') window.updateVenditoriSelect();
      if (typeof window.updateVenditoriList  === 'function') window.updateVenditoriList();
    });

    // Realtime: CONTRACTS
    firebase.database().ref('contracts').on('value', function(snap){
      FB.contractKeyByLocalId.clear(); window.contracts = [];
      var data = snap.val() || {}; var id = 1;
      Object.keys(data).forEach(function(key){
        var c = data[key] || {};
        var obj = {
          id: id++, meseProduzione: c.meseProduzione || '', dataIngresso: c.dataIngresso || '', dataOrdine: c.dataOrdine || '', venditore: String(c.venditore || '').toUpperCase(), prodotto: c.prodotto || '', nomeStudente: c.nomeStudente || '', cognomeStudente: c.cognomeStudente || '', prezzo: Number(c.prezzo || 0), rateizzazione: c.rateizzazione || 'Bonifico', numeroContratti: parseInt(c.numeroContratti || 1), incassi: normalizeIncassi(c.incassi), stornato: !!c.stornato, dataStorno: c.dataStorno || '', timestamp: c.timestamp || Date.now()
        };
        window.contracts.push(obj); FB.contractKeyByLocalId.set(obj.id, key);
      });
      if (document.getElementById('contratti')?.classList.contains('active') && typeof window.loadContracts === 'function') window.loadContracts();
      if (document.getElementById('report')?.classList.contains('active')    && typeof window.updateDashboard === 'function') window.updateDashboard();
    });

    // Override: aggiungi venditore
    window.aggiungiVenditore = function () {
      var input = document.getElementById('nuovoVenditore'); var nome = (input && input.value || '').trim().toUpperCase();
      if (!nome) { alert('‚ö†Ô∏è Inserisci il nome del venditore'); return; }
      if ((window.venditori || []).some(function(v){ return v.attivo !== false && v.nome === nome; })) { alert('‚ö†Ô∏è Questo venditore esiste gi√†'); return; }
      firebase.database().ref('venditori').push({ nome: nome, attivo: true, createdAt: Date.now() }).then(function(){ input.value=''; notify('‚úÖ Venditore aggiunto'); }).catch(function(){ alert('Errore salvataggio venditore'); });
    };

    // Override: rimuovi venditore (attivo:false)
    window.rimuoviVenditore = function (id) {
      var vend = (window.venditori || []).find(function(v){ return v.id === id; }); if (!vend) return;
      if (!confirm('‚ö†Ô∏è Vuoi rimuovere questo venditore?')) return; var key = FB.venditoreKeyByName.get(vend.nome); if (!key) return;
      firebase.database().ref('venditori/'+key).update({ attivo:false }).then(function(){ notify('‚úÖ Venditore rimosso'); }).catch(function(){ alert('Errore rimozione venditore'); });
    };

    // Override: elimina contratto
    window.deleteContract = function (id) {
      if (!confirm('‚ö†Ô∏è Eliminare definitivamente questo contratto?')) return; var key = FB.contractKeyByLocalId.get(id); if (!key) return;
      firebase.database().ref('contracts/'+key).remove().then(function(){ notify('‚úÖ Contratto eliminato'); }).catch(function(){ alert('Errore eliminazione contratto'); });
    };

    // Override: storna contratto
    window.stornaContract = function (id) {
      if (!confirm('‚ö†Ô∏è Stornare questo contratto?')) return; var key = FB.contractKeyByLocalId.get(id); if (!key) return;
      var today = new Date().toISOString().slice(0,10);
      firebase.database().ref('contracts/'+key).update({ stornato:true, dataStorno: today }).then(function(){ notify('‚ö†Ô∏è Contratto stornato'); }).catch(function(){ alert('Errore storno contratto'); });
    };

    // Persistenza contratto dopo il submit originale
    (function attachPersist(){
      var form = document.getElementById('contractForm'); if (!form) return;
      form.addEventListener('submit', function(){
        setTimeout(function(){
          try{
            var mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
            var incassi = {}; mesi.forEach(function(M){ var el = document.getElementById('incasso'+M); var val = el ? parseFloat(String(el.value).replace(',','.'))||0 : 0; if (val>0) incassi[M.toLowerCase()] = val; });
            var payload = { meseProduzione: document.getElementById('meseProduzione').value, dataIngresso: document.getElementById('dataIngresso').value, dataOrdine: document.getElementById('dataOrdine').value, venditore: (document.getElementById('venditore').value||'').toUpperCase(), prodotto: document.getElementById('prodotto').value, nomeStudente: (document.getElementById('nomeStudente').value||'').trim(), cognomeStudente: (document.getElementById('cognomeStudente').value||'').trim(), prezzo: parseFloat(document.getElementById('prezzo').value), rateizzazione: document.getElementById('rateizzazione').value, numeroContratti: parseInt(document.getElementById('numeroContratti').value||'1'), incassi: incassi, stornato:false, timestamp: Date.now() };
            if(!payload.meseProduzione || !payload.dataIngresso || !payload.dataOrdine || !payload.venditore || !payload.prodotto || !payload.nomeStudente || !payload.cognomeStudente || isNaN(payload.prezzo)){ return; }
            db.ref('contracts').push(payload);
          }catch(e){ console.error('Persistenza Firebase fallita:', e); }
        }, 0);
      }, false);
    })();
  })();
  </script>

</body>
</html>
