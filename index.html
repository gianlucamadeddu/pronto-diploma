<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pronto Diploma - Sistema Gestione Contratti v3.0 (Firebase)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .hidden{display:none!important}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center;position:relative}
    .header h1{font-size:2.2em;margin-bottom:6px}
    .demo-badge{position:absolute;top:20px;left:20px;background:#ffc107;color:#333;padding:5px 12px;border-radius:15px;font-size:.85em;font-weight:bold}
    .tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef;flex-wrap:wrap}
    .tab{padding:15px 25px;cursor:pointer;background:none;border:none;font-size:1em;font-weight:500;color:#6c757d;transition:.3s;white-space:nowrap}
    .tab:hover{color:#495057}
    .tab.active{color:#667eea}
    .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;background:#667eea}
    .content{padding:30px}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:600;margin-bottom:8px;color:#495057;font-size:.9em}
    .form-group input,.form-group select{padding:12px;border:2px solid #e9ecef;border-radius:8px;font-size:1em;transition:.3s}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .btn{padding:12px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.3)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#6c757d}
    .btn-danger{background:#dc3545}
    .btn-success{background:#28a745}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th{background:#f8f9fa;padding:12px;text-align:left;font-weight:600;color:#495057;border-bottom:2px solid #e9ecef}
    td{padding:12px;border-bottom:1px solid #e9ecef}
    tr:hover{background:#f8f9fa}
    .actions{display:flex;gap:10px}
    .btn-small{padding:6px 12px;font-size:.85em}
    .notification{position:fixed;top:20px;right:20px;background:#4ade80;color:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);animation:slideIn .3s;z-index:1000}
    @keyframes slideIn{from{transform:translateX(400px)}to{transform:translateX(0)}}
    .search-section{background:#e8f4fd;border:2px solid #0066cc;border-radius:12px;padding:20px;margin-bottom:25px}
    .search-grid{display:grid;grid-template-columns:1fr 1fr auto;gap:15px;align-items:end}
    .search-results{margin-top:15px;max-height:200px;overflow-y:auto;background:#fff;border-radius:8px;padding:10px;display:none}
    .search-result-item{padding:10px;border-bottom:1px solid #e9ecef;cursor:pointer;transition:.3s}
    .search-result-item:hover{background:#f8f9fa}
    .month-filter{display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
    .export-btn{margin-left:auto}
    .incassi-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px}
    .incassi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-top:15px}
    .venditori-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin:20px 0}
    .venditore-card{background:#fff;border:2px solid #e9ecef;border-radius:8px;padding:15px;display:flex;justify-content:space-between;align-items:center;transition:.3s}
    .venditore-card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.2)}
    .venditore-name{font-weight:600;color:#495057}
    @media(max-width:768px){.tabs{overflow-x:auto}.tab{padding:12px 20px;font-size:.9em}.export-btn{margin-left:0;width:100%;margin-top:10px}.search-grid{grid-template-columns:1fr}}
    /* Login */
    .login-container{position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;z-index:10000}
    .login-box{background:#fff;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:400px;max-width:90%}
    .login-header{text-align:center;margin-bottom:30px}
    .login-header h1{color:#667eea;font-size:2em;margin-bottom:10px}
    .login-header p{color:#6c757d}
    .login-error{color:#dc3545;text-align:center;margin-top:15px;display:none}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <h1>üéì Pronto Diploma</h1>
        <p>Sistema di Gestione Contratti</p>
      </div>
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="userId">ID Utente</label>
          <input type="text" id="userId" required autocomplete="username"/>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autocomplete="current-password"/>
        </div>
        <button type="submit" class="btn">Accedi</button>
        <div id="loginError" class="login-error">ID o password non validi</div>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="mainContainer" class="container hidden">
    <div class="header">
      <span class="demo-badge">VERSIONE 3.0 ‚Ä¢ Firebase</span>
      <h1>üéì Pronto Diploma</h1>
      <p>Sistema di Gestione Contratti e Report</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="inserimento">üìù Inserimento</button>
      <button class="tab" data-tab="venditori">üë• Venditori</button>
      <button class="tab" data-tab="contratti">üìã Contratti</button>
      <button class="tab" data-tab="importa">üì§ Importa Excel</button>
      <button class="tab" data-tab="report">üìä Report</button>
      <button class="tab" data-tab="analytics">üìà Analytics</button>
    </div>

    <div class="content">
      <!-- Inserimento -->
      <div id="inserimento" class="tab-content active">
        <h2 style="margin-bottom:20px;">Nuovo Contratto</h2>

        <div class="search-section">
          <h3>üîç Ricerca Studente Esistente</h3>
          <div class="search-grid">
            <input type="text" id="searchNome" placeholder="Cerca per nome...">
            <input type="text" id="searchCognome" placeholder="Cerca per cognome...">
            <button class="btn btn-secondary" id="clearSearchBtn">Pulisci</button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </div>

        <form id="contractForm">
          <div class="form-grid">
            <div class="form-group">
              <label>Mese Produzione *</label>
              <select id="meseProduzione" required></select>
            </div>
            <div class="form-group">
              <label>Data Ingresso Lead *</label>
              <input type="date" id="dataIngresso" required>
            </div>
            <div class="form-group">
              <label>Data Ordine *</label>
              <input type="date" id="dataOrdine" required>
            </div>
            <div class="form-group">
              <label>Venditore *</label>
              <select id="venditore" required></select>
            </div>
            <div class="form-group">
              <label>Prodotto *</label>
              <select id="prodotto" required>
                <option value="">Seleziona...</option>
                <option value="ON LINE">ON LINE</option>
                <option value="VIRTUAL">VIRTUAL</option>
              </select>
            </div>
            <div class="form-group">
              <label>Nome Studente *</label>
              <input type="text" id="nomeStudente" required>
            </div>
            <div class="form-group">
              <label>Cognome Studente *</label>
              <input type="text" id="cognomeStudente" required>
            </div>
            <div class="form-group">
              <label>Prezzo (‚Ç¨) *</label>
              <input type="number" step="0.01" id="prezzo" required>
            </div>
            <div class="form-group">
              <label>Tipo Rateizzazione</label>
              <select id="rateizzazione">
                <option value="Bonifico">Bonifico</option>
                <option value="Link To Pay">Link To Pay</option>
                <option value="Banca Sella Prestito al Consumo">Banca Sella Prestito al Consumo</option>
                <option value="Rateizzazione Interna">Rateizzazione Interna</option>
                <option value="Scalapay">Scalapay</option>
                <option value="Acconto + Link To Pay">Acconto + Link To Pay</option>
                <option value="Acconto + Banca Sella">Acconto + Banca Sella Prestito al Consumo</option>
              </select>
            </div>
            <div class="form-group">
              <label>Numero Contratti</label>
              <input type="number" id="numeroContratti" value="1" min="1">
            </div>
          </div>

          <div class="incassi-section">
            <h3>üí∞ Incassi Mensili</h3>
            <p style="margin-top:10px;color:#6c757d;">Inserisci gli importi previsti per ogni mese (lascia vuoto se non previsto)</p>
            <div class="incassi-grid" id="incassiGrid"></div>
          </div>

          <button type="submit" class="btn" id="saveBtn">‚úÖ Salva Contratto</button>
        </form>
      </div>

      <!-- Venditori -->
      <div id="venditori" class="tab-content">
        <h2 style="margin-bottom:20px;">Gestione Venditori</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
          <input type="text" id="nuovoVenditore" placeholder="Nome nuovo venditore" maxlength="50" style="flex:1;min-width:200px;padding:12px;border:2px solid #e9ecef;border-radius:8px">
          <button class="btn btn-success" id="addVenditoreBtn">‚ûï Aggiungi Venditore</button>
        </div>
        <h3 style="margin-bottom:15px;">Venditori Attivi</h3>
        <div id="venditoriList" class="venditori-list"></div>
      </div>

      <!-- Contratti -->
      <div id="contratti" class="tab-content">
        <div class="month-filter">
          <h2>Elenco Contratti</h2>
          <select id="filterMonth">
            <option value="">Tutti i mesi</option>
            <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
            <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
            <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
            <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
          </select>
          <select id="filterYear">
            <option value="">Tutti gli anni</option>
            <option>2024</option><option selected>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option>
          </select>
          <select id="filterVenditore"><option value="">Tutti i venditori</option></select>
          <button class="btn btn-secondary export-btn" id="exportBtn">üì• Esporta Excel</button>
        </div>
        <div id="contractsList"></div>
      </div>

      <!-- Importa -->
      <div id="importa" class="tab-content">
        <h2>Importazione File Excel</h2>
        <div style="background:#e7f3ff;border:2px solid #0066cc;border-radius:12px;padding:20px;margin:20px 0;">
          <h3 style="color:#0066cc;margin-bottom:15px;">üìã Formato File Excel Richiesto</h3>
          <ol style="margin-left:20px;line-height:1.8">
            <li><strong>INGRESSO LEAD</strong> (AAAA-MM-GG)</li>
            <li><strong>Data ordine</strong> (AAAA-MM-GG)</li>
            <li><strong>SALES</strong></li>
            <li><strong>Prodotto</strong> (ON LINE / VIRTUAL)</li>
            <li><strong>Membro / Referente</strong> (Nome e Cognome)</li>
            <li><strong>Prezzo</strong> (numero)</li>
            <li><strong>Rateizzato</strong></li>
            <li><strong>N CTR</strong></li>
            <li><strong>INCASSO [MESE]</strong> (Gennaio‚Ä¶Dicembre)</li>
          </ol>
        </div>
        <div style="background:#fff;border:2px dashed #ddd;border-radius:12px;padding:40px;text-align:center;margin:20px 0;">
          <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
          <div id="dropZone">
            <div style="font-size:48px;color:#667eea;margin-bottom:20px">üìÅ</div>
            <h3 style="margin-bottom:15px;">Trascina qui il file Excel</h3>
            <p style="color:#666;margin-bottom:20px;">oppure</p>
            <button class="btn" id="selectFileBtn">Seleziona File</button>
          </div>
        </div>
        <div id="importPreview" style="display:none">
          <h3 style="margin:20px 0;">Anteprima Dati</h3>
          <div id="previewInfo" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;"></div>
          <div style="max-height:400px;overflow-y:auto">
            <table id="previewTable" style="font-size:.9em;"></table>
          </div>
          <div style="margin-top:20px;display:flex;gap:10px">
            <button class="btn btn-success" id="confirmImportBtn">‚úÖ Conferma Importazione</button>
            <button class="btn btn-secondary" id="cancelImportBtn">‚ùå Annulla</button>
          </div>
        </div>
        <div id="importResults" style="display:none;margin-top:20px;">
          <div style="background:#d4edda;border:1px solid #c3e6cb;border-radius:8px;padding:15px;">
            <h4 style="color:#155724;margin-bottom:10px;">‚úÖ Importazione Completata</h4>
            <div id="importStats"></div>
          </div>
        </div>
      </div>

      <!-- Report -->
      <div id="report" class="tab-content">
        <h2>Dashboard Report</h2>
        <div class="month-filter" style="margin-bottom:25px;">
          <select id="reportFilterMonth">
            <option value="">Seleziona mese...</option>
            <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
            <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
            <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
            <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
          </select>
          <select id="reportFilterYear">
            <option>2024</option><option selected>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option>
          </select>
          <select id="reportFilterVenditore"><option value="">Tutti i venditori</option></select>
        </div>
        <div id="dashboardSummary" style="display:none">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">
            <div class="stat-card"><h3>Contratti del Mese</h3><div class="value" id="dashTotContratti">0</div></div>
            <div class="stat-card"><h3>Incasso del Mese</h3><div class="value" id="dashIncassoMese">‚Ç¨ 0,00</div></div>
            <div class="stat-card"><h3>Ricavo Totale Mese</h3><div class="value" id="dashRicavoMese">‚Ç¨ 0,00</div></div>
            <div class="stat-card" style="background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);">
              <h3>Contratti Stornati</h3><div class="value" id="dashStornati">0</div>
              <div style="font-size:.9em;margin-top:5px;">Valore: <span id="dashValoreStornati">‚Ç¨ 0</span></div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%);">
              <h3>Prodotti</h3>
              <div style="font-size:1.1em;margin-top:10px;">
                <div style="margin-bottom:8px;">üì± Online: <strong id="dashOnline">0</strong></div>
                <div>üíª Virtual: <strong id="dashVirtual">0</strong></div>
              </div>
            </div>
          </div>
        </div>
        <div id="dashboardNoData" style="text-align:center;padding:40px;background:#f8f9fa;border-radius:12px;margin-bottom:30px;">
          <p style="color:#6c757d;font-size:1.1em;">Seleziona un mese per visualizzare la dashboard e il report dettagliato</p>
        </div>
        <div id="reportContent"></div>
      </div>

      <!-- Analytics (placeholder per continuit√† con v2.1) -->
      <div id="analytics" class="tab-content">
        <h2>Analytics - Analisi Comparativa</h2>
        <p style="color:#6c757d;margin-top:10px">In questa versione i dati sono in tempo reale da Firebase. Possiamo attivare i confronti tra periodi in un secondo step.</p>
      </div>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase v9 (Modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, push, set, update, remove, onValue, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    // --- CONFIG FIREBASE (fornita da Gianluca) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAKAs06_n8t19KH5CxMGisxZGM1Q5kpiU0",
      authDomain: "pronto-diploma.firebaseapp.com",
      databaseURL: "https://pronto-diploma-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "pronto-diploma",
      storageBucket: "pronto-diploma.firebasestorage.app",
      messagingSenderId: "640164355453",
      appId: "1:640164355453:web:7c79a591af4869c54f4014"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // --- STATO IN MEMORIA (solo per UI) ---
    let currentUser = null;
    let tempImportRows = [];
    const users = {
      'Amministrazione': { password: 'prontodiploma', permissions: ['inserimento','venditori','contratti'] },
      'Gianluca Madeddu': { password: 'sono1975', permissions: ['inserimento','venditori','contratti','importa','report','analytics'] }
    };

    // Utility UI
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);
    function notify(msg){
      const n=document.createElement('div'); n.className='notification'; n.textContent=msg;
      document.body.appendChild(n); setTimeout(()=>n.remove(),3000);
    }

    // Login
    $('#loginForm').addEventListener('submit',(e)=>{
      e.preventDefault();
      const id=$('#userId').value.trim();
      const pwd=$('#password').value.trim();
      if(users[id]?.password===pwd){
        currentUser={id,permissions:users[id].permissions};
        $('#loginContainer').style.display='none';
        $('#mainContainer').classList.remove('hidden');
        setupTabs();
        initMeseProduzione();
        initIncassiGrid();
        bindRealtime();
        notify('Benvenuto!');
      }else{
        $('#loginError').style.display='block';
        $('#password').value='';
      }
    });

    function setupTabs(){
      $$('.tab').forEach(btn=>{
        const name=btn.dataset.tab;
        // visibilit√† per permessi
        if(!currentUser.permissions.includes(name)) btn.style.display='none';
        btn.addEventListener('click',()=>{
          $$('.tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          $$('.tab-content').forEach(c=>c.classList.remove('active'));
          $('#'+name).classList.add('active');
          if(name==='contratti') renderContracts();
          if(name==='report') updateDashboard();
        });
      });
      // mostro il primo tab disponibile
      const first=currentUser.permissions[0];
      $(`.tab[data-tab="${first}"]`)?.click();
    }

    // Mesi & incassi UI
    function initMeseProduzione(){
      const sel=$('#meseProduzione'); sel.innerHTML='';
      const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      const curY=(new Date()).getFullYear(), curM=(new Date()).getMonth()+1;
      const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='Seleziona...'; sel.appendChild(opt0);
      for(let y=2024;y<=2030;y++){
        months.forEach((m,idx)=>{
          const v=`${y}-${String(idx+1).padStart(2,'0')}`;
          const o=document.createElement('option'); o.value=v; o.textContent=`${m} ${y}`;
          if(y===curY && idx+1===curM) o.selected=true;
          sel.appendChild(o);
        });
      }
      // default date fields
      $('#dataIngresso').valueAsDate=new Date();
      $('#dataOrdine').valueAsDate=new Date();
    }

    function initIncassiGrid(){
      const grid=$('#incassiGrid'); grid.innerHTML='';
      const mesi=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      mesi.forEach(m=>{
        const wrap=document.createElement('div'); wrap.className='incasso-month';
        wrap.innerHTML=`<label>${m}</label><input type="number" step="0.01" id="incasso${m}" placeholder="0.00">`;
        grid.appendChild(wrap);
      });
    }

    // --- Firebase: REFS ---
    const contractsRef = ref(db,'contracts');
    const venditoriRef = ref(db,'venditori');

    // Bind real-time
    function bindRealtime(){
      // Venditori -> select e lista
      onValue(venditoriRef,(snap)=>{
        const data=snap.val()||{};
        const list = Object.entries(data)
          .map(([id,v])=>({id,...v}))
          .filter(v=>v.attivo!==false)
          .sort((a,b)=>a.nome.localeCompare(b.nome));

        // select venditore
        const selects=['#venditore','#filterVenditore','#reportFilterVenditore'];
        selects.forEach(sel=>{
          const el=$(sel); if(!el) return;
          el.innerHTML = (sel==='#venditore') ? '<option value="">Seleziona...</option>' : '<option value="">Tutti i venditori</option>';
          list.forEach(v=>{
            const o=document.createElement('option'); o.value=v.nome; o.textContent=v.nome; el.appendChild(o);
          });
        });

        // lista UI
        const listEl = $('#venditoriList');
        if(listEl){
          if(list.length===0){ listEl.innerHTML='<p style="text-align:center;padding:40px;color:#6c757d;">Nessun venditore presente</p>'; }
          else{
            listEl.innerHTML = list.map(v=>`
              <div class="venditore-card">
                <span class="venditore-name">${v.nome}</span>
                <button class="btn btn-danger btn-small" data-remove-venditore="${v.id}">üóëÔ∏è</button>
              </div>
            `).join('');
            listEl.querySelectorAll('[data-remove-venditore]').forEach(b=>{
              b.addEventListener('click', async ()=>{
                if(confirm('‚ö†Ô∏è Vuoi rimuovere questo venditore?')){
                  await update(ref(db,`venditori/${b.dataset.removeVenditore}`),{attivo:false});
                  notify('‚úÖ Venditore rimosso');
                }
              });
            });
          }
        }
      });

      // Contracts -> filtri / report riletti on demand (render dinamico)
      // Non facciamo rendering completo ad ogni change per performance;
      // le viste chiamano get() quando servono.
    }

    // Aggiungi venditore
    $('#addVenditoreBtn').addEventListener('click', async ()=>{
      const nome = ($('#nuovoVenditore').value||'').trim().toUpperCase();
      if(!nome){ alert('‚ö†Ô∏è Inserisci il nome del venditore'); return; }
      // verifica esistenza (case-insensitive)
      const snap=await get(venditoriRef);
      const exists = Object.values(snap.val()||{}).some(v=>v?.attivo!==false && (v?.nome||'').toUpperCase()===nome);
      if(exists){ alert('‚ö†Ô∏è Questo venditore esiste gi√†'); return; }
      const newRef = push(venditoriRef);
      await set(newRef,{nome,attivo:true,createdAt:Date.now()});
      $('#nuovoVenditore').value='';
      notify('‚úÖ Venditore aggiunto');
    });

    // Salva contratto
    $('#contractForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const saveBtn=$('#saveBtn'); saveBtn.disabled=true; saveBtn.textContent='‚è≥ Salvataggio...';
      try{
        const incassi={};
        const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
        months.forEach(m=>{
          const v=parseFloat(($('#incasso'+m).value||'').replace(',','.'))||0;
          if(v>0) incassi[m.toLowerCase()] = v;
        });

        const contract={
          meseProduzione: $('#meseProduzione').value,
          dataIngresso: $('#dataIngresso').value,
          dataOrdine:   $('#dataOrdine').value,
          venditore:    $('#venditore').value,
          prodotto:     $('#prodotto').value,
          nomeStudente: ($('#nomeStudente').value||'').trim(),
          cognomeStudente: ($('#cognomeStudente').value||'').trim(),
          prezzo:       parseFloat($('#prezzo').value),
          rateizzazione: $('#rateizzazione').value,
          numeroContratti: parseInt($('#numeroContratti').value||'1'),
          incassi,
          stornato: false,
          timestamp: Date.now()
        };

        // Validazioni minime
        if(!contract.meseProduzione || !contract.dataIngresso || !contract.dataOrdine || !contract.venditore || !contract.prodotto || !contract.nomeStudente || !contract.cognomeStudente || !contract.prezzo){
          alert('Compila tutti i campi obbligatori'); saveBtn.disabled=false; saveBtn.textContent='‚úÖ Salva Contratto'; return;
        }

        await set(push(contractsRef), contract);

        notify('‚úÖ Contratto salvato con successo!');
        e.target.reset();
        initMeseProduzione(); // ripristina date e selezioni default
      }catch(err){
        console.error(err); alert('Errore nel salvataggio');
      }finally{
        saveBtn.disabled=false; saveBtn.textContent='‚úÖ Salva Contratto';
      }
    });

    // Ricerca studenti (DB)
    async function searchStudents(){
      const nome = ($('#searchNome').value||'').toLowerCase();
      const cogn = ($('#searchCognome').value||'').toLowerCase();
      const resultsDiv = $('#searchResults');
      if(!nome && !cogn){ resultsDiv.style.display='none'; return; }
      const snap = await get(contractsRef);
      const all = Object.entries(snap.val()||{}).map(([id,c])=>({id,...c}));
      const filtered = all.filter(c=>{
        const m1 = nome ? (c.nomeStudente||'').toLowerCase().includes(nome) : true;
        const m2 = cogn ? (c.cognomeStudente||'').toLowerCase().includes(cogn) : true;
        return m1 && m2;
      }).slice(0,50);
      if(filtered.length){
        resultsDiv.innerHTML = filtered.map(c=>`
          <div class="search-result-item" data-pick="${c.nomeStudente}|||${c.cognomeStudente}">
            <strong>${c.nomeStudente} ${c.cognomeStudente}</strong> - ${c.prodotto} - ‚Ç¨${Number(c.prezzo||0).toFixed(2)} - ${new Date(c.dataOrdine).toLocaleDateString('it-IT')}
          </div>
        `).join('');
      }else{
        resultsDiv.innerHTML = '<div style="padding:10px;color:#6c757d;">Nessuno studente trovato</div>';
      }
      resultsDiv.style.display='block';
      resultsDiv.querySelectorAll('[data-pick]').forEach(el=>{
        el.addEventListener('click',()=>{
          const [n,c] = el.dataset.pick.split('|||');
          $('#nomeStudente').value=n; $('#cognomeStudente').value=c;
          clearSearch();
        });
      });
    }
    $('#searchNome').addEventListener('keyup',searchStudents);
    $('#searchCognome').addEventListener('keyup',searchStudents);
    function clearSearch(){ $('#searchNome').value=''; $('#searchCognome').value=''; $('#searchResults').style.display='none'; }
    $('#clearSearchBtn').addEventListener('click',clearSearch);

    // Render contratti (filtri DB)
    async function renderContracts(){
      const m = $('#filterMonth').value;
      const y = $('#filterYear').value;
      const v = $('#filterVenditore').value;
      const listEl = $('#contractsList');
      listEl.innerHTML = '<p style="padding:20px;color:#6c757d;">Caricamento...</p>';

      const snap = await get(contractsRef);
      let all = Object.entries(snap.val()||{}).map(([id,c])=>({_id:id,...c}));
      // filtri
      if(m || y){
        all = all.filter(c=>{
          if(!c.meseProduzione) return false;
          const [yy,mm] = c.meseProduzione.split('-');
          const okM = m ? Number(mm)===Number(m) : true;
          const okY = y ? String(yy)===String(y) : true;
          return okM && okY;
        });
      }
      if(v) all = all.filter(c=>String(c.venditore)===String(v));
      // sort per data
      all.sort((a,b)=> new Date(b.dataOrdine) - new Date(a.dataOrdine));

      if(all.length===0){ listEl.innerHTML='<p style="text-align:center;padding:40px;color:#6c757d;">Nessun contratto trovato</p>'; return; }

      const monthNames=['','Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
      const rows = all.map(c=>{
        const totInc = Object.values(c.incassi||{}).reduce((s,val)=>s+Number(val||0),0);
        let meseTxt='-';
        if(c.meseProduzione){
          const [yy,mm]=c.meseProduzione.split('-');
          meseTxt = `${monthNames[parseInt(mm)]} ${yy}`;
        }
        return `
          <tr>
            <td><strong>${meseTxt}</strong></td>
            <td>${c.dataOrdine?new Date(c.dataOrdine).toLocaleDateString('it-IT'):'-'}</td>
            <td>${c.venditore||''}</td>
            <td>${c.nomeStudente||''} ${c.cognomeStudente||''}</td>
            <td><span style="background:${c.prodotto==='ON LINE'?'#667eea':'#764ba2'};color:#fff;padding:2px 8px;border-radius:4px">${c.prodotto||''}</span></td>
            <td>‚Ç¨ ${Number(c.prezzo||0).toFixed(2)}</td>
            <td style="font-size:.9em">${c.rateizzazione||''}</td>
            <td>${Number(c.numeroContratti||1)}</td>
            <td>‚Ç¨ ${totInc.toFixed(2)}</td>
            <td class="actions">
              ${c.stornato ? '<span style="color:#dc3545;font-weight:bold;">STORNATO</span>' :
                `<button class="btn btn-secondary btn-small" data-storna="${c._id}">‚ö†Ô∏è</button>`}
              <button class="btn btn-danger btn-small" data-delete="${c._id}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');

      listEl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Mese Prod.</th><th>Data Ordine</th><th>Venditore</th><th>Studente</th>
              <th>Prodotto</th><th>Prezzo</th><th>Rateizzazione</th><th>N¬∞ CTR</th><th>Incassi Tot.</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <p style="margin-top:20px;color:#6c757d;">Totale contratti: ${all.length}</p>
      `;

      // actions
      listEl.querySelectorAll('[data-storna]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          if(confirm('‚ö†Ô∏è Stornare questo contratto?')){
            await update(ref(db,`contracts/${b.dataset.storna}`),{stornato:true,dataStorno:new Date().toISOString().slice(0,10)});
            notify('‚ö†Ô∏è Contratto stornato'); renderContracts();
          }
        });
      });
      listEl.querySelectorAll('[data-delete]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          if(confirm('‚ö†Ô∏è Eliminare definitivamente questo contratto?')){
            await remove(ref(db,`contracts/${b.dataset.delete}`));
            notify('‚úÖ Contratto eliminato'); renderContracts();
          }
        });
      });
    }
    $('#filterMonth').addEventListener('change',renderContracts);
    $('#filterYear').addEventListener('change',renderContracts);
    $('#filterVenditore').addEventListener('change',renderContracts);

    // Export (CSV semplice per Excel)
    $('#exportBtn').addEventListener('click', async ()=>{
      const snap = await get(contractsRef);
      const all = Object.entries(snap.val()||{}).map(([id,c])=>({id,...c}));
      if(all.length===0){ alert('Nessun dato da esportare'); return; }
      const headers = ['id','meseProduzione','dataIngresso','dataOrdine','venditore','prodotto','nomeStudente','cognomeStudente','prezzo','rateizzazione','numeroContratti','stornato','incassi_json'];
      const lines = [headers.join(';')];
      all.forEach(c=>{
        const row = [
          c.id||'',
          c.meseProduzione||'',
          c.dataIngresso||'',
          c.dataOrdine||'',
          c.venditore||'',
          c.prodotto||'',
          c.nomeStudente||'',
          c.cognomeStudente||'',
          (c.prezzo??''),
          c.rateizzazione||'',
          (c.numeroContratti??''),
          (c.stornato?1:0),
          JSON.stringify(c.incassi||{})
        ].map(v=>String(v).replace(/;/g,','));
        lines.push(row.join(';'));
      });
      const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`contratti_export_${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
    });

    // Report
    async function updateDashboard(){
      const month=parseInt($('#reportFilterMonth').value);
      const year =parseInt($('#reportFilterYear').value);
      const vend = $('#reportFilterVenditore').value;
      if(!month){ $('#dashboardSummary').style.display='none'; $('#dashboardNoData').style.display='block'; $('#reportContent').innerHTML=''; return; }
      $('#dashboardSummary').style.display='block'; $('#dashboardNoData').style.display='none';

      const snap = await get(contractsRef);
      const all = Object.entries(snap.val()||{}).map(([id,c])=>({id,...c}));
      const allFiltered = all.filter(c=>{
        if(!c.meseProduzione) return false;
        const [y,m]=String(c.meseProduzione).split('-');
        const ok = parseInt(m)===month && parseInt(y)===year;
        return ok && (!vend || c.venditore===vend);
      });
      const valid = allFiltered.filter(c=>!c.stornato);
      const storn = allFiltered.filter(c=>c.stornato);

      const monthNames=['','gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
      const mKey = monthNames[month];

      let totContr=0, incassoMese=0, ricavoTot=0, online=0, virtual=0;
      valid.forEach(c=>{
        totContr += Number(c.numeroContratti||1);
        ricavoTot += Number(c.prezzo||0);
        incassoMese += c.incassi?.[mKey] ? Number(c.incassi[mKey]) : 0;
        if(c.prodotto==='ON LINE') online++; else if(c.prodotto==='VIRTUAL') virtual++;
      });
      let totSt=0, valSt=0;
      storn.forEach(c=>{ totSt += Number(c.numeroContratti||1); valSt += Number(c.prezzo||0); });

      $('#dashTotContratti').textContent=totContr;
      $('#dashIncassoMese').textContent='‚Ç¨ '+incassoMese.toLocaleString('it-IT',{minimumFractionDigits:2});
      $('#dashRicavoMese').textContent='‚Ç¨ '+ricavoTot.toLocaleString('it-IT',{minimumFractionDigits:2});
      $('#dashOnline').textContent=online;
      $('#dashVirtual').textContent=virtual;
      $('#dashStornati').textContent=totSt;
      $('#dashValoreStornati').textContent='‚Ç¨ '+valSt.toLocaleString('it-IT',{minimumFractionDigits:2});

      // Report dettagliato per venditore
      const perVend = {};
      valid.forEach(c=>{
        if(!perVend[c.venditore]) perVend[c.venditore]={contr:0,incasso:0,ricavo:0,online:0,virtual:0};
        perVend[c.venditore].contr += Number(c.numeroContratti||1);
        perVend[c.venditore].ricavo += Number(c.prezzo||0);
        perVend[c.venditore].incasso += c.incassi?.[mKey]?Number(c.incassi[mKey]):0;
        if(c.prodotto==='ON LINE') perVend[c.venditore].online++; else if(c.prodotto==='VIRTUAL') perVend[c.venditore].virtual++;
      });
      const monthNamesFull=['','Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      const rows = Object.entries(perVend)
        .sort((a,b)=>b[1].ricavo-a[1].ricavo)
        .map(([nome,data],idx)=>{
          const perc = data.ricavo?((data.incasso/data.ricavo)*100):0;
          const medal = idx===0?'ü•á ':idx===1?'ü•à ':idx===2?'ü•â ':'';
          return `
            <tr style="${idx<3?'background:#fffbf0;':''}">
              <td><strong>${medal}${nome}</strong></td>
              <td>${data.contr}</td>
              <td>‚Ç¨ ${data.incasso.toLocaleString('it-IT',{minimumFractionDigits:2})}</td>
              <td>‚Ç¨ ${data.ricavo.toLocaleString('it-IT',{minimumFractionDigits:2})}</td>
              <td>‚Ç¨ ${(data.contr?data.incasso/data.contr:0).toLocaleString('it-IT',{minimumFractionDigits:2})}</td>
              <td>‚Ç¨ ${(data.contr?data.ricavo/data.contr:0).toLocaleString('it-IT',{minimumFractionDigits:2})}</td>
              <td><strong>${perc.toFixed(2)}%</strong></td>
              <td>${data.online}/${data.virtual}</td>
            </tr>
          `;
        }).join('');
      $('#reportContent').innerHTML = `
        <div style="margin-top:30px;">
          <h3 style="margin-bottom:20px;">üìä Report Dettaglio Venditori - ${monthNamesFull[month]} ${year}</h3>
          <table>
            <thead>
              <tr>
                <th>Venditore</th><th>N¬∞ Contratti</th><th>Incasso ${monthNamesFull[month]}</th><th>Ricavo Totale</th>
                <th>Media Incasso</th><th>Media/Contratto</th><th>% Incasso</th><th>Online/Virtual</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#6c757d">Nessun dato</td></tr>'}</tbody>
          </table>
        </div>
      `;
    }
    $('#reportFilterMonth').addEventListener('change',updateDashboard);
    $('#reportFilterYear').addEventListener('change',updateDashboard);
    $('#reportFilterVenditore').addEventListener('change',updateDashboard);

    // Import Excel
    const dropZone = $('#dropZone');
    const fileInput = $('#excelFile');
    $('#selectFileBtn').addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',handleFile);
    dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.style.opacity='.8'});
    dropZone.addEventListener('dragleave',()=>{dropZone.style.opacity='1'});
    dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.style.opacity='1'; if(e.dataTransfer.files?.[0]) parseExcel(e.dataTransfer.files[0])});

    function handleFile(e){ const f=e.target.files?.[0]; if(f) parseExcel(f); }
    function parseExcel(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data,{type:'array'});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws,{defval:''});
        tempImportRows = json;
        // anteprima
        $('#importPreview').style.display='block';
        $('#previewInfo').innerHTML = `<strong>Foglio:</strong> ${sheetName} ‚Ä¢ <strong>Righe:</strong> ${json.length}`;
        const headers = Object.keys(json[0]||{});
        const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
        const tbody = `<tbody>${json.slice(0,50).map(r=>`<tr>${headers.map(h=>`<td>${String(r[h])}</td>`).join('')}</tr>`).join('')}</tbody>`;
        $('#previewTable').innerHTML = thead+tbody;
      };
      reader.readAsArrayBuffer(file);
    }
    $('#confirmImportBtn').addEventListener('click', async ()=>{
      if(tempImportRows.length===0){ alert('Nessun dato da importare'); return; }
      let ok=0, ko=0;
      for(const r of tempImportRows){
        try{
          const nomeCogn = String(r['Membro / Referente']||' ').trim().split(' ');
          const nome = nomeCogn.slice(0,-1).join(' ') || nomeCogn[0] || '';
          const cogn = nomeCogn.slice(-1).join(' ') || '';
          const incassi={}; const mesiMap={Gennaio:'gennaio',Febbraio:'febbraio',Marzo:'marzo',Aprile:'aprile',Maggio:'maggio',Giugno:'giugno',Luglio:'luglio',Agosto:'agosto',Settembre:'settembre',Ottobre:'ottobre',Novembre:'novembre',Dicembre:'dicembre'};
          Object.keys(mesiMap).forEach(k=>{
            const v=parseFloat(String(r[`INCASSO ${k}`]||'').replace(',','.'))||0;
            if(v>0) incassi[mesiMap[k]]=v;
          });
          const c = {
            meseProduzione: inferMeseProduzioneFromSheetTitle(), // opzionale: puoi rinominarlo es. "LUGLIO 2025"
            dataIngresso: r['INGRESSO LEAD']||'',
            dataOrdine: r['Data ordine']||'',
            venditore: r['SALES']||'',
            prodotto: r['Prodotto']||'',
            nomeStudente: nome,
            cognomeStudente: cogn,
            prezzo: parseFloat(String(r['Prezzo']||'').replace(',','.'))||0,
            rateizzazione: r['Rateizzato']||'',
            numeroContratti: parseInt(r['N CTR']||'1'),
            incassi,
            stornato:false,
            timestamp: Date.now()
          };
          await set(push(contractsRef),c);
          ok++;
        }catch(e){ console.error(e); ko++; }
      }
      $('#importResults').style.display='block';
      $('#importStats').innerHTML = `<p>Import riusciti: <strong>${ok}</strong> ‚Ä¢ Errori: <strong style="color:#dc3545">${ko}</strong></p>`;
      notify('‚úÖ Importazione completata');
      tempImportRows=[];
      $('#importPreview').style.display='none';
      $('#previewTable').innerHTML='';
    });
    $('#cancelImportBtn').addEventListener('click',()=>{
      tempImportRows=[]; $('#importPreview').style.display='none'; $('#previewTable').innerHTML='';
    });
    function inferMeseProduzioneFromSheetTitle(){
      // Placeholder: imposta il mese corrente AAAA-MM
      const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    // Cambio tab iniziale click handler (delegation)
    document.addEventListener('click',(e)=>{
      const t=e.target.closest('.tab'); if(!t) return;
      $$('.tab').forEach(b=>b.classList.remove('active')); t.classList.add('active');
      $$('.tab-content').forEach(c=>c.classList.remove('active'));
      $('#'+t.dataset.tab).classList.add('active');
      if(t.dataset.tab==='contratti') renderContracts();
      if(t.dataset.tab==='report') updateDashboard();
    });
  </script>
</body>
</html>
