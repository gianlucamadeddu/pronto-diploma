<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronto Diploma - Sistema Gestione Contratti v2.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .login-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 400px; max-width: 90%;
        }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: #8BC53F; font-size: 2em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-header p { color: #6c757d; }
        .login-form .form-group { margin-bottom: 20px; }
        .login-form label { display: block; margin-bottom: 8px; color: #495057; font-weight: 600; }
        .login-form input {
            width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em; transition: all 0.3s;
        }
        .login-form input:focus { outline: none; border-color: #8BC53F; box-shadow: 0 0 0 3px rgba(139,197,63,0.1); }
        .login-btn {
            width: 100%; padding: 12px; background: linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%);
            color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(139,197,63,0.3); }
        .login-error { color: #dc3545; text-align: center; margin-top: 15px; display: none; }
        .hidden { display: none !important; }

        .container {
            max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%); color: white; padding: 30px; text-align: center; position: relative;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .demo-badge {
            position: absolute; top: 20px; left: 20px; background: #ffc107; color: #333; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold;
        }

        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; flex-wrap: wrap; }
        .tab {
            padding: 15px 25px; cursor: pointer; background: none; border: none; font-size: 1em; font-weight: 500;
            color: #6c757d; transition: all 0.3s; position: relative; white-space: nowrap;
            display: flex; align-items: center; gap: 8px;
        }
        .tab:hover { color: #495057; }
        .tab.active { color: #8BC53F; }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background: #8BC53F; }
        .tab svg { width: 18px; height: 18px; }

        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

        .search-section { background: #e8f4fd; border: 2px solid #0066cc; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .search-section h3 { color: #0066cc; margin-bottom: 15px; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        .search-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; }
        .search-results {
            margin-top: 15px; max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; padding: 10px; display: none;
        }
        .search-result-item { padding: 10px; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background 0.3s; }
        .search-result-item:hover { background: #f8f9fa; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 0.9em; }
        .form-group input, .form-group select {
            padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em; transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #8BC53F; box-shadow: 0 0 0 3px rgba(139,197,63,0.1); }

        .btn {
            padding: 12px 30px; background: linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%);
            color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(139,197,63,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { box-shadow: 0 10px 20px rgba(108,117,125,0.3); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { box-shadow: 0 10px 20px rgba(220,53,69,0.3); }
        .btn-success { background: #28a745; }
        .btn-success:hover { box-shadow: 0 10px 20px rgba(40,167,69,0.3); }
        .btn svg { width: 18px; height: 18px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%); color: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .stat-card .value { font-size: 2em; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef; }
        td { padding: 12px; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }

        .month-filter { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .month-filter select { padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em; }
        .actions { display: flex; gap: 8px; }
        .btn-small { padding: 8px 12px; font-size: 0.85em; }
        .btn-small svg { width: 16px; height: 16px; }

        .notification {
            position: fixed; top: 20px; right: 20px; background: #4ade80; color: white; padding: 16px 24px;
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideIn 0.3s; z-index: 1000;
            display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideIn { from { transform: translateX(400px);} to { transform: translateX(0);} }

        .incassi-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .incassi-section h3 { display: flex; align-items: center; gap: 8px; }
        .incassi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .incasso-month { display: flex; flex-direction: column; }
        .incasso-month label { font-size: 0.85em; color: #6c757d; margin-bottom: 5px; }
        .incasso-month input { padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; }

        .venditori-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .venditore-card {
            background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s;
        }
        .venditore-card:hover { border-color: #8BC53F; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(139,197,63,0.2); }
        .venditore-name { font-weight: 600; color: #495057; }
        .add-venditore-form { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .add-venditore-form input { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; }

        .import-section { background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .import-section h3 { color: #856404; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .import-preview { margin-top: 20px; max-height: 300px; overflow: auto; }
        .import-preview table { font-size: 0.9em; }
        .import-actions { margin-top: 20px; display: flex; gap: 10px; }

        @media (max-width: 768px) {
            .tabs { overflow-x: auto; }
            .tab { padding: 12px 20px; font-size: 0.9em; }
            .search-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                        <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                        <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                    </svg>
                    Pronto Diploma
                </h1>
                <p>Sistema di Gestione Contratti</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="userId">ID Utente</label>
                    <input type="text" id="userId" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                        <polyline points="10 17 15 12 10 7"/>
                        <line x1="15" y1="12" x2="3" y2="12"/>
                    </svg>
                    Accedi
                </button>
                <div id="loginError" class="login-error">ID o password non validi</div>
            </form>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="container hidden">
        <div class="header">
            <span class="demo-badge">VERSIONE 2.1</span>
            <h1>
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                    <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                </svg>
                Pronto Diploma
            </h1>
            <p>Sistema di Gestione Contratti e Report</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('inserimento', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Inserimento
            </button>
            <button class="tab" onclick="showTab('venditori', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Venditori
            </button>
            <button class="tab" onclick="showTab('contratti', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Contratti
            </button>
            <button class="tab" onclick="showTab('importa', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Importa Excel
            </button>
            <button class="tab" onclick="showTab('report', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Report
            </button>
            <button class="tab" onclick="showTab('analytics', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"/>
                    <line x1="18" y1="20" x2="18" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="16"/>
                </svg>
                Analytics
            </button>
        </div>

        <div class="content">
            <!-- Tab Inserimento -->
            <div id="inserimento" class="tab-content active">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="12" y1="18" x2="12" y2="12"/>
                        <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    Nuovo Contratto
                </h2>

                <div class="search-section">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0066cc" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        Ricerca Studente Esistente
                    </h3>
                    <div class="search-grid">
                        <input type="text" id="searchNome" placeholder="Cerca per nome..." onkeyup="searchStudents()">
                        <input type="text" id="searchCognome" placeholder="Cerca per cognome..." onkeyup="searchStudents()">
                        <button class="btn btn-secondary" onclick="clearSearch()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Pulisci
                        </button>
                    </div>
                    <div id="searchResults" class="search-results"></div>
                </div>

                <form id="contractForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mese Produzione *</label>
                            <select id="meseProduzione" required><option value="">Seleziona...</option></select>
                        </div>
                        <div class="form-group">
                            <label>Data Ingresso Lead *</label>
                            <input type="date" id="dataIngresso" required>
                        </div>
                        <div class="form-group">
                            <label>Data Ordine *</label>
                            <input type="date" id="dataOrdine" required>
                        </div>
                        <div class="form-group">
                            <label>Venditore *</label>
                            <select id="venditore" required><option value="">Seleziona...</option></select>
                        </div>
                        <div class="form-group">
                            <label>Prodotto *</label>
                            <select id="prodotto" required>
                                <option value="">Seleziona...</option>
                                <option value="ON LINE">ON LINE</option>
                                <option value="VIRTUAL">VIRTUAL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nome Studente *</label>
                            <input type="text" id="nomeStudente" required>
                        </div>
                        <div class="form-group">
                            <label>Cognome Studente *</label>
                            <input type="text" id="cognomeStudente" required>
                        </div>
                        <div class="form-group">
                            <label>Prezzo (€) *</label>
                            <input type="number" id="prezzo" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo Rateizzazione</label>
                            <select id="rateizzazione">
                                <option value="Bonifico">Bonifico</option>
                                <option value="Link To Pay">Link To Pay</option>
                                <option value="Banca Sella Prestito al Consumo">Banca Sella Prestito al Consumo</option>
                                <option value="Rateizzazione Interna">Rateizzazione Interna</option>
                                <option value="Scalapay">Scalapay</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Numero Contratti</label>
                            <input type="number" id="numeroContratti" value="1" min="1">
                        </div>
                    </div>

                    <div class="incassi-section">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Incassi Mensili
                        </h3>
                        <p style="margin-top: 10px; color: #6c757d;">Inserisci gli importi previsti per ogni mese</p>
                        <div class="incassi-grid">
                            <div class="incasso-month"><label>Gennaio</label><input type="number" id="incassoGennaio" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Febbraio</label><input type="number" id="incassoFebbraio" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Marzo</label><input type="number" id="incassoMarzo" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Aprile</label><input type="number" id="incassoAprile" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Maggio</label><input type="number" id="incassoMaggio" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Giugno</label><input type="number" id="incassoGiugno" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Luglio</label><input type="number" id="incassoLuglio" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Agosto</label><input type="number" id="incassoAgosto" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Settembre</label><input type="number" id="incassoSettembre" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Ottobre</label><input type="number" id="incassoOttobre" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Novembre</label><input type="number" id="incassoNovembre" step="0.01" placeholder="0.00"></div>
                            <div class="incasso-month"><label>Dicembre</label><input type="number" id="incassoDicembre" step="0.01" placeholder="0.00"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="saveBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Salva Contratto
                    </button>
                </form>
            </div>

            <!-- Tab Venditori -->
            <div id="venditori" class="tab-content">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Gestione Venditori
                </h2>
                <div class="add-venditore-form">
                    <input type="text" id="nuovoVenditore" placeholder="Nome nuovo venditore" maxlength="50">
                    <button class="btn btn-success" onclick="aggiungiVenditore()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Aggiungi Venditore
                    </button>
                </div>
                <h3 style="margin-bottom: 15px;">Venditori Attivi</h3>
                <div id="venditoriList" class="venditori-list"></div>
            </div>

            <!-- Tab Contratti -->
            <div id="contratti" class="tab-content">
                <div class="month-filter">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Elenco Contratti
                    </h2>
                    <select id="filterMonth" onchange="loadContracts()">
                        <option value="">Tutti i mesi</option>
                        <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
                        <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
                        <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
                        <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
                    </select>
                    <select id="filterYear" onchange="loadContracts()">
                        <option value="">Tutti gli anni</option>
                        <option value="2024">2024</option><option value="2025" selected>2025</option><option value="2026">2026</option>
                    </select>
                    <select id="filterVenditore" onchange="loadContracts()">
                        <option value="">Tutti i venditori</option>
                    </select>
                </div>
                <div id="contractsList"></div>
            </div>

            <!-- Tab Importa Excel -->
            <div id="importa" class="tab-content">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Importa da Excel
                </h2>
                <div class="import-section">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                            <polyline points="13 2 13 9 20 9"/>
                        </svg>
                        Carica file Excel (.xlsx, .xls)
                    </h3>
                    <p style="margin: 15px 0; color: #856404;">Il file deve contenere le colonne: Mese Produzione, Data Ingresso, Data Ordine, Venditore, Prodotto, Nome, Cognome, Prezzo, Rateizzazione</p>
                    <div class="file-input-wrapper">
                        <button class="btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Seleziona File
                        </button>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="previewExcel(event)">
                    </div>
                    <span id="fileName" style="margin-left: 15px; color: #6c757d;"></span>
                </div>
                <div id="importPreview" class="import-preview" style="display: none;"></div>
                <div id="importActions" class="import-actions" style="display: none;">
                    <button class="btn btn-success" onclick="confirmImport()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Conferma Importazione
                    </button>
                    <button class="btn btn-secondary" onclick="cancelImport()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Annulla
                    </button>
                </div>
            </div>

            <!-- Tab Report -->
            <div id="report" class="tab-content">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Dashboard Report
                </h2>
                <div class="month-filter" style="margin: 25px 0;">
                    <select id="reportFilterMonth" onchange="updateDashboard()">
                        <option value="">Seleziona mese...</option>
                        <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
                        <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
                        <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
                        <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
                    </select>
                    <select id="reportFilterYear" onchange="updateDashboard()">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <select id="reportFilterVenditore" onchange="updateDashboard()">
                        <option value="">Tutti i venditori</option>
                    </select>
                </div>

                <div id="dashboardSummary" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                Contratti del Mese
                            </h3>
                            <div class="value" id="dashTotContratti">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"/>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                                Incasso del Mese
                            </h3>
                            <div class="value" id="dashIncassoMese">€ 0,00</div>
                        </div>
                        <div class="stat-card">
                            <h3>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"/>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                                Ricavo Totale Mese
                            </h3>
                            <div class="value" id="dashRicavoMese">€ 0,00</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <h3>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                                Contratti Stornati
                            </h3>
                            <div class="value" id="dashStornati">0</div>
                        </div>
                    </div>
                </div>

                <div id="dashboardNoData" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 12px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="1.5" style="margin-bottom: 15px;">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    <p style="color: #6c757d; font-size: 1.1em;">Seleziona un mese per visualizzare la dashboard</p>
                </div>

                <div id="reportContent"></div>
            </div>

            <!-- Tab Analytics -->
            <div id="analytics" class="tab-content">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"/>
                        <line x1="18" y1="20" x2="18" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="16"/>
                    </svg>
                    Analytics Avanzate
                </h2>
                <div class="month-filter" style="margin: 25px 0;">
                    <select id="analyticsYear" onchange="updateAnalytics()">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <div id="analyticsContent">
                    <p style="text-align: center; padding: 40px; color: #6c757d;">Seleziona un anno per visualizzare le analytics</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- SheetJS per Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
/* =========================
   Firebase Configuration
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAKAs06_n8t19KH5CxMGisxZGM1Q5kpiU0",
  authDomain: "pronto-diploma.firebaseapp.com",
  databaseURL: "https://pronto-diploma-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pronto-diploma",
  storageBucket: "pronto-diploma.appspot.com",
  messagingSenderId: "640164355453",
  appId: "1:640164355453:web:7c79a591af4869c54f4014"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* =========================
   Stato in memoria
   ========================= */
let contracts = [];
let venditori = [];
let nextId = 1;
let nextVenditoreId = 1;
let tempImportData = [];
let currentUser = null;
let editingContractId = null;

// SVG Icons
const icons = {
    edit: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
    warning: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
    trash: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
    check: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`,
    save: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
    x: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`
};

/* =========================
   Login
   ========================= */
const users = {
  'Amministrazione': { password: 'prontodiploma', permissions: ['inserimento','venditori','contratti','importa'] },
  'Gianluca Madeddu': { password: 'sono1975', permissions: ['inserimento','venditori','contratti','importa','report','analytics'] }
};

function login(userId, password) {
  if (users[userId] && users[userId].password === password) {
    currentUser = { id: userId, permissions: users[userId].permissions };
    return true;
  }
  return false;
}

document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('userId').value;
  const password = document.getElementById('password').value;
  if (login(userId, password)) {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').classList.remove('hidden');
    updateTabsVisibility();
    showTab('inserimento');
    initializeApp();
  } else {
    document.getElementById('loginError').style.display = 'block';
  }
});

/* =========================
   Tabs
   ========================= */
function updateTabsVisibility() {
  const tabMapping = {
    'inserimento': 'Inserimento',
    'venditori': 'Venditori',
    'contratti': 'Contratti',
    'importa': 'Importa Excel',
    'report': 'Report',
    'analytics': 'Analytics'
  };
  document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
  currentUser.permissions.forEach(permission => {
    const tabText = tabMapping[permission];
    document.querySelectorAll('.tab').forEach(tab => {
      if (tab.textContent.includes(tabText)) tab.style.display = 'flex';
    });
  });
}

function showTab(tabName, event) {
  if (event) event.preventDefault();
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

  const tabMapping = {
    'inserimento': 'Inserimento',
    'venditori': 'Venditori',
    'contratti': 'Contratti',
    'importa': 'Importa Excel',
    'report': 'Report',
    'analytics': 'Analytics'
  };
  
  if (event && event.currentTarget) {
    event.currentTarget.classList.add('active');
  } else {
    document.querySelectorAll('.tab').forEach(tab => {
      if (tab.textContent.includes(tabMapping[tabName])) tab.classList.add('active');
    });
  }
  
  const tabContent = document.getElementById(tabName);
  if (tabContent) tabContent.classList.add('active');

  if (tabName === 'contratti') loadContracts();
  else if (tabName === 'report') updateDashboard();
  else if (tabName === 'analytics') updateAnalytics();
}

/* =========================
   Inizializzazione
   ========================= */
function initializeApp() {
  try {
    initializeFilters();
    loadVenditori();
    loadContractsData();
    document.getElementById('dataIngresso').valueAsDate = new Date();
    document.getElementById('dataOrdine').valueAsDate = new Date();
  } catch (error) { console.error('Errore in initializeApp:', error); }
}

function initializeFilters() {
  try {
    const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    const meseProdSelect = document.getElementById('meseProduzione');
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    
    meseProdSelect.innerHTML = '<option value="">Seleziona...</option>';
    for (let year = 2024; year <= 2026; year++) {
      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = `${year}-${String(index + 1).padStart(2,'0')}`;
        option.text = `${month} ${year}`;
        if (year === currentYear && index + 1 === currentMonth) option.selected = true;
        meseProdSelect.appendChild(option);
      });
    }
  } catch (error) { console.error('Errore in initializeFilters:', error); }
}

function showNotification(message, icon = 'check') {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.innerHTML = icons[icon] + ' ' + message;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}

/* =========================
   Venditori (Firebase)
   ========================= */
function loadVenditori() {
  try {
    database.ref('venditori').on('value', (snapshot) => {
      venditori = [];
      snapshot.forEach((child) => { venditori.push({ ...child.val(), id: child.key }); });
      updateVenditoriSelect();
      updateVenditoriList();
    });
  } catch (error) { console.error('Errore in loadVenditori:', error); }
}

function updateVenditoriSelect() {
  try {
    const activeVenditori = venditori.filter(v => v.attivo !== false);
    ['venditore', 'filterVenditore', 'reportFilterVenditore'].forEach(selectId => {
      const select = document.getElementById(selectId);
      if (select) {
        const firstOption = selectId === 'venditore' ? '<option value="">Seleziona...</option>' : '<option value="">Tutti i venditori</option>';
        select.innerHTML = firstOption + activeVenditori.map(v => `<option value="${v.nome}">${v.nome}</option>`).join('');
      }
    });
  } catch (error) { console.error('Errore in updateVenditoriSelect:', error); }
}

function updateVenditoriList() {
  try {
    const list = document.getElementById('venditoriList');
    const activeVenditori = venditori.filter(v => v.attivo !== false);
    
    if (activeVenditori.length === 0) {
      list.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Nessun venditore presente</p>';
      return;
    }
    
    list.innerHTML = activeVenditori.map(v => `
      <div class="venditore-card">
        <span class="venditore-name">${v.nome}</span>
        <button class="btn btn-danger btn-small" onclick="rimuoviVenditore('${v.id}')">${icons.trash}</button>
      </div>
    `).join('');
  } catch (error) { console.error('Errore in updateVenditoriList:', error); }
}

function aggiungiVenditore() {
  try {
    const nome = (document.getElementById('nuovoVenditore').value || '').trim().toUpperCase();
    if (!nome) { alert('Inserisci il nome del venditore'); return; }
    if (venditori.some(v => v.nome === nome && v.attivo !== false)) { alert('Questo venditore esiste già'); return; }
    
    database.ref('venditori').push({ nome, attivo: true });
    document.getElementById('nuovoVenditore').value = '';
    showNotification('Venditore aggiunto');
  } catch (error) { console.error('Errore in aggiungiVenditore:', error); }
}

function rimuoviVenditore(id) {
  try {
    if (confirm('Vuoi rimuovere questo venditore?')) {
      database.ref('venditori/' + id).update({ attivo: false });
      showNotification('Venditore rimosso');
    }
  } catch (error) { console.error('Errore in rimuoviVenditore:', error); }
}

/* =========================
   Ricerca Studenti
   ========================= */
function searchStudents() {
  try {
    const searchNome = (document.getElementById('searchNome').value || '').toLowerCase();
    const searchCognome = (document.getElementById('searchCognome').value || '').toLowerCase();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!searchNome && !searchCognome) { resultsDiv.style.display = 'none'; return; }

    const filtered = contracts.filter(c => {
      const matchNome = searchNome ? (c.nomeStudente || '').toLowerCase().includes(searchNome) : true;
      const matchCognome = searchCognome ? (c.cognomeStudente || '').toLowerCase().includes(searchCognome) : true;
      return matchNome && matchCognome;
    });

    if (filtered.length > 0) {
      resultsDiv.innerHTML = filtered.slice(0,10).map(c => `
        <div class="search-result-item" onclick="selectStudent('${c.id}')">
          <strong>${c.nomeStudente} ${c.cognomeStudente}</strong> - ${c.prodotto} - €${Number(c.prezzo).toFixed(2)}
        </div>
      `).join('');
      resultsDiv.style.display = 'block';
    } else {
      resultsDiv.innerHTML = '<div style="padding: 10px; color: #6c757d;">Nessuno studente trovato</div>';
      resultsDiv.style.display = 'block';
    }
  } catch (error) { console.error('Errore in searchStudents:', error); }
}

function selectStudent(id) {
  try {
    const contract = contracts.find(c => c.id === id);
    if (contract) {
      document.getElementById('nomeStudente').value = contract.nomeStudente || '';
      document.getElementById('cognomeStudente').value = contract.cognomeStudente || '';
      clearSearch();
    }
  } catch (error) { console.error('Errore in selectStudent:', error); }
}

function clearSearch() {
  document.getElementById('searchNome').value = '';
  document.getElementById('searchCognome').value = '';
  document.getElementById('searchResults').style.display = 'none';
}

/* =========================
   CRUD Contratti (Firebase)
   ========================= */
function loadContractsData() {
  try {
    database.ref('contracts').on('value', (snapshot) => {
      contracts = [];
      snapshot.forEach((child) => { contracts.push({ ...child.val(), id: child.key }); });
    });
  } catch (error) { console.error('Errore in loadContractsData:', error); }
}

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('contractForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      try {
        e.preventDefault();
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;

        const incassi = {};
        const mesi = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
        mesi.forEach(mese => {
          const inputId = 'incasso' + mese.charAt(0).toUpperCase() + mese.slice(1);
          const value = parseFloat(document.getElementById(inputId).value) || 0;
          if (value > 0) incassi[mese] = value;
        });

        const contract = {
          meseProduzione: document.getElementById('meseProduzione').value,
          dataIngresso: document.getElementById('dataIngresso').value,
          dataOrdine: document.getElementById('dataOrdine').value,
          venditore: document.getElementById('venditore').value,
          prodotto: document.getElementById('prodotto').value,
          nomeStudente: document.getElementById('nomeStudente').value.trim(),
          cognomeStudente: document.getElementById('cognomeStudente').value.trim(),
          prezzo: parseFloat(document.getElementById('prezzo').value),
          rateizzazione: document.getElementById('rateizzazione').value,
          numeroContratti: parseInt(document.getElementById('numeroContratti').value),
          incassi: incassi,
          timestamp: Date.now()
        };

        let savePromise;
        if (editingContractId) {
          savePromise = database.ref('contracts/' + editingContractId).update(contract);
        } else {
          savePromise = database.ref('contracts').push(contract);
        }

        savePromise.then(()=>{
          const isEdit = !!editingContractId;
          showNotification(isEdit ? 'Contratto aggiornato con successo!' : 'Contratto salvato con successo!');
          
          editingContractId = null;
          const cancelBtn = document.getElementById('cancelEditBtn');
          if (cancelBtn) cancelBtn.remove();
          
          form.reset();
          document.getElementById('dataIngresso').valueAsDate = new Date();
          document.getElementById('dataOrdine').valueAsDate = new Date();
          document.getElementById('numeroContratti').value = 1;
          initializeFilters();
          saveBtn.disabled = false;
          saveBtn.innerHTML = icons.check + ' Salva Contratto';
          saveBtn.style.background = 'linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%)';
        }).catch(err=>{
          console.error('Errore nel salvataggio:', err);
          saveBtn.disabled = false;
          saveBtn.innerHTML = editingContractId ? icons.save + ' Aggiorna Contratto' : icons.check + ' Salva Contratto';
        });
      } catch (error) {
        console.error('Errore nel salvataggio:', error);
        const btn = document.getElementById('saveBtn');
        if (btn) { btn.disabled = false; btn.innerHTML = icons.check + ' Salva Contratto'; }
      }
    });
  }
});

function loadContracts() {
  try {
    database.ref('contracts').once('value', (snapshot) => {
      contracts = [];
      snapshot.forEach((child) => { contracts.push({ ...child.val(), id: child.key }); });

      const filterMonth = document.getElementById('filterMonth').value;
      const filterYear = document.getElementById('filterYear').value;
      const filterVenditore = document.getElementById('filterVenditore').value;

      let filtered = contracts;

      if (filterMonth || filterYear) {
        filtered = filtered.filter(c => {
          const [cYear, cMonth] = (c.meseProduzione || '').split('-');
          const matchMonth = filterMonth ? parseInt(cMonth) == filterMonth : true;
          const matchYear = filterYear ? cYear === filterYear : true;
          return matchMonth && matchYear;
        });
      }
      if (filterVenditore) filtered = filtered.filter(c => c.venditore === filterVenditore);

      filtered.sort((a, b) => new Date(b.dataOrdine || 0) - new Date(a.dataOrdine || 0));

      const html = (filtered.length === 0)
        ? '<p style="text-align: center; padding: 40px; color: #6c757d;">Nessun contratto trovato</p>'
        : `
          <table>
            <thead>
              <tr>
                <th>Mese Prod.</th><th>Data Ordine</th><th>Venditore</th><th>Studente</th>
                <th>Prodotto</th><th>Prezzo</th><th>Rateizzazione</th><th>N° CTR</th><th>Tot. Incassi</th><th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(c => {
                const [year, month] = (c.meseProduzione || '0000-01').split('-');
                const monthNames = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
                const mIdx = Math.max(1, Math.min(12, parseInt(month || '1'))) - 1;
                const meseProdText = `${monthNames[mIdx]} ${year}`;
                const badgeColor = (c.prodotto === 'ON LINE') ? '#8BC53F' : '#6B6B5A';
                const totIncassi = c.incassi ? Object.values(c.incassi).reduce((a,b) => a + Number(b), 0) : 0;
                const prezzo = Number(c.prezzo || 0).toFixed(2);
                const actions = c.stornato
                  ? '<span style="color: #dc3545; font-weight: bold;">STORNATO</span>'
                  : `<button class="btn btn-small" onclick="editContract('${c.id}')" title="Modifica" style="background:#8BC53F;">${icons.edit}</button>
                     <button class="btn btn-secondary btn-small" onclick="stornaContract('${c.id}')" title="Storna">${icons.warning}</button>`;
                return `
                  <tr>
                    <td><strong>${meseProdText}</strong></td>
                    <td>${c.dataOrdine ? new Date(c.dataOrdine).toLocaleDateString('it-IT') : ''}</td>
                    <td>${c.venditore || ''}</td>
                    <td>${(c.nomeStudente||'') + ' ' + (c.cognomeStudente||'')}</td>
                    <td><span style="background: ${badgeColor}; color: white; padding: 2px 8px; border-radius: 4px;">${c.prodotto || ''}</span></td>
                    <td>€ ${prezzo}</td>
                    <td style="font-size: 0.85em;">${c.rateizzazione || ''}</td>
                    <td>${Number(c.numeroContratti || 0)}</td>
                    <td>€ ${totIncassi.toFixed(2)}</td>
                    <td class="actions">
                      ${actions}
                      <button class="btn btn-danger btn-small" onclick="deleteContract('${c.id}')">${icons.trash}</button>
                    </td>
                  </tr>`;
              }).join('')}
            </tbody>
          </table>
          <p style="margin-top: 20px; color: #6c757d;">Totale contratti: ${filtered.length}</p>
        `;
      document.getElementById('contractsList').innerHTML = html;
    });
  } catch (error) { console.error('Errore in loadContracts:', error); }
}

/* =========================
   Modifica Contratto
   ========================= */
function editContract(id) {
  try {
    const contract = contracts.find(c => c.id === id);
    if (!contract) { alert('Contratto non trovato'); return; }

    editingContractId = id;

    document.getElementById('meseProduzione').value = contract.meseProduzione || '';
    document.getElementById('dataIngresso').value = contract.dataIngresso || '';
    document.getElementById('dataOrdine').value = contract.dataOrdine || '';
    document.getElementById('venditore').value = contract.venditore || '';
    document.getElementById('prodotto').value = contract.prodotto || '';
    document.getElementById('nomeStudente').value = contract.nomeStudente || '';
    document.getElementById('cognomeStudente').value = contract.cognomeStudente || '';
    document.getElementById('prezzo').value = contract.prezzo || '';
    document.getElementById('rateizzazione').value = contract.rateizzazione || 'Bonifico';
    document.getElementById('numeroContratti').value = contract.numeroContratti || 1;

    const mesi = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
    mesi.forEach(mese => {
      const inputId = 'incasso' + mese.charAt(0).toUpperCase() + mese.slice(1);
      const input = document.getElementById(inputId);
      if (input) input.value = (contract.incassi && contract.incassi[mese]) ? contract.incassi[mese] : '';
    });

    const saveBtn = document.getElementById('saveBtn');
    saveBtn.innerHTML = icons.save + ' Aggiorna Contratto';
    saveBtn.style.background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';

    if (!document.getElementById('cancelEditBtn')) {
      const cancelBtn = document.createElement('button');
      cancelBtn.id = 'cancelEditBtn';
      cancelBtn.type = 'button';
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.innerHTML = icons.x + ' Annulla Modifica';
      cancelBtn.style.marginLeft = '10px';
      cancelBtn.onclick = cancelEdit;
      saveBtn.parentNode.insertBefore(cancelBtn, saveBtn.nextSibling);
    }

    showTab('inserimento');
    showNotification('Modifica contratto: ' + contract.nomeStudente + ' ' + contract.cognomeStudente, 'edit');
  } catch (error) { console.error('Errore in editContract:', error); }
}

function cancelEdit() {
  try {
    editingContractId = null;
    document.getElementById('contractForm').reset();
    document.getElementById('dataIngresso').valueAsDate = new Date();
    document.getElementById('dataOrdine').valueAsDate = new Date();
    document.getElementById('numeroContratti').value = 1;
    initializeFilters();

    const saveBtn = document.getElementById('saveBtn');
    saveBtn.innerHTML = icons.check + ' Salva Contratto';
    saveBtn.style.background = 'linear-gradient(135deg, #8BC53F 0%, #6B6B5A 100%)';

    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) cancelBtn.remove();

    showNotification('Modifica annullata', 'x');
  } catch (error) { console.error('Errore in cancelEdit:', error); }
}

function stornaContract(id) {
  try {
    if (confirm('Vuoi stornare questo contratto?')) {
      database.ref('contracts/' + id).update({ stornato: true });
      showNotification('Contratto stornato', 'warning');
      loadContracts();
    }
  } catch (error) { console.error('Errore in stornaContract:', error); }
}

function deleteContract(id) {
  try {
    if (confirm('Eliminare definitivamente questo contratto?')) {
      database.ref('contracts/' + id).remove();
      showNotification('Contratto eliminato');
      loadContracts();
    }
  } catch (error) { console.error('Errore in deleteContract:', error); }
}

/* =========================
   Report
   ========================= */
function updateDashboard() {
  try {
    const month = parseInt(document.getElementById('reportFilterMonth').value);
    const year = parseInt(document.getElementById('reportFilterYear').value);
    const filterVenditore = document.getElementById('reportFilterVenditore').value;

    if (!month) {
      document.getElementById('dashboardSummary').style.display = 'none';
      document.getElementById('dashboardNoData').style.display = 'block';
      document.getElementById('reportContent').innerHTML = '';
      return;
    }

    document.getElementById('dashboardSummary').style.display = 'block';
    document.getElementById('dashboardNoData').style.display = 'none';

    database.ref('contracts').once('value', (snapshot) => {
      let allContracts = [];
      snapshot.forEach((child) => { allContracts.push({ ...child.val(), id: child.key }); });

      let allFiltered = allContracts.filter(c => {
        const [cYear, cMonth] = (c.meseProduzione || '').split('-');
        return parseInt(cMonth) === month && parseInt(cYear) === year;
      });
      if (filterVenditore) allFiltered = allFiltered.filter(c => c.venditore === filterVenditore);

      const filtered = allFiltered.filter(c => !c.stornato);
      const stornati = allFiltered.filter(c => c.stornato);

      const monthNames = ['', 'Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      const meseKey = monthNames[month].toLowerCase();

      let totaleContratti = 0, incassoMese = 0, ricavoTotale = 0;
      filtered.forEach(c => {
        totaleContratti += Number(c.numeroContratti || 0);
        ricavoTotale += Number(c.prezzo || 0);
        incassoMese += (c.incassi && c.incassi[meseKey]) ? Number(c.incassi[meseKey]) : 0;
      });

      document.getElementById('dashTotContratti').textContent = totaleContratti;
      document.getElementById('dashIncassoMese').textContent = '€ ' + incassoMese.toLocaleString('it-IT', {minimumFractionDigits: 2});
      document.getElementById('dashRicavoMese').textContent = '€ ' + ricavoTotale.toLocaleString('it-IT', {minimumFractionDigits: 2});
      document.getElementById('dashStornati').textContent = stornati.length;

      if (filtered.length === 0) {
        document.getElementById('reportContent').innerHTML = '<div style="background: #f8f9fa; border-radius: 12px; padding: 30px; text-align: center;"><p style="color: #6c757d;">Nessun contratto trovato per i criteri selezionati</p></div>';
        return;
      }

      const venditorData = {};
      filtered.forEach(c => {
        if (!venditorData[c.venditore]) venditorData[c.venditore] = { contratti: 0, incassoMese: 0, ricavoTotale: 0 };
        venditorData[c.venditore].contratti += Number(c.numeroContratti || 0);
        venditorData[c.venditore].incassoMese += (c.incassi && c.incassi[meseKey]) ? Number(c.incassi[meseKey]) : 0;
        venditorData[c.venditore].ricavoTotale += Number(c.prezzo || 0);
      });

      const sortedVenditori = Object.entries(venditorData).sort((a, b) => b[1].ricavoTotale - a[1].ricavoTotale);

      const medalIcons = {
        0: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFD700" stroke="#FFD700" stroke-width="1"><circle cx="12" cy="8" r="6"/><path d="M8 14l-3 8 7-4 7 4-3-8" fill="#FFD700"/></svg>`,
        1: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#C0C0C0" stroke="#C0C0C0" stroke-width="1"><circle cx="12" cy="8" r="6"/><path d="M8 14l-3 8 7-4 7 4-3-8" fill="#C0C0C0"/></svg>`,
        2: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#CD7F32" stroke="#CD7F32" stroke-width="1"><circle cx="12" cy="8" r="6"/><path d="M8 14l-3 8 7-4 7 4-3-8" fill="#CD7F32"/></svg>`
      };

      document.getElementById('reportContent').innerHTML = `
        <div style="margin-top: 30px;">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            Report Dettaglio Venditori - ${monthNames[month]} ${year}
          </h3>
          <table>
            <thead>
              <tr><th>Venditore</th><th>N° Contratti</th><th>Incasso ${monthNames[month]}</th><th>Ricavo Totale</th></tr>
            </thead>
            <tbody>
              ${sortedVenditori.map(([nome, data], index) => {
                const medal = medalIcons[index] || '';
                return `
                <tr style="${index < 3 ? 'background: #fffbf0;' : ''}">
                  <td style="display: flex; align-items: center; gap: 8px;"><strong>${medal} ${nome}</strong></td>
                  <td>${data.contratti}</td>
                  <td>€ ${data.incassoMese.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                  <td>€ ${data.ricavoTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    });
  } catch (error) { console.error('Errore in updateDashboard:', error); }
}

/* =========================
   Analytics
   ========================= */
function updateAnalytics() {
  try {
    const year = document.getElementById('analyticsYear').value;
    
    database.ref('contracts').once('value', (snapshot) => {
      let allContracts = [];
      snapshot.forEach((child) => { allContracts.push({ ...child.val(), id: child.key }); });

      const yearContracts = allContracts.filter(c => {
        const [cYear] = (c.meseProduzione || '').split('-');
        return cYear === year && !c.stornato;
      });

      if (yearContracts.length === 0) {
        document.getElementById('analyticsContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Nessun dato disponibile per l\'anno selezionato</p>';
        return;
      }

      const monthlyData = {};
      const monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      
      monthNames.forEach((m, i) => {
        monthlyData[i+1] = { nome: m, contratti: 0, ricavo: 0, incasso: 0 };
      });

      yearContracts.forEach(c => {
        const [, cMonth] = (c.meseProduzione || '').split('-');
        const monthNum = parseInt(cMonth);
        if (monthlyData[monthNum]) {
          monthlyData[monthNum].contratti += Number(c.numeroContratti || 0);
          monthlyData[monthNum].ricavo += Number(c.prezzo || 0);
          const meseKey = monthNames[monthNum-1].toLowerCase();
          monthlyData[monthNum].incasso += (c.incassi && c.incassi[meseKey]) ? Number(c.incassi[meseKey]) : 0;
        }
      });

      const totaleAnno = yearContracts.reduce((sum, c) => sum + Number(c.prezzo || 0), 0);
      const totaleContratti = yearContracts.reduce((sum, c) => sum + Number(c.numeroContratti || 0), 0);

      document.getElementById('analyticsContent').innerHTML = `
        <div class="stats-grid" style="margin-bottom: 30px;">
          <div class="stat-card">
            <h3>Totale Contratti ${year}</h3>
            <div class="value">${totaleContratti}</div>
          </div>
          <div class="stat-card">
            <h3>Ricavo Totale ${year}</h3>
            <div class="value">€ ${totaleAnno.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
          </div>
          <div class="stat-card">
            <h3>Media per Contratto</h3>
            <div class="value">€ ${(totaleAnno / (totaleContratti || 1)).toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
          </div>
        </div>
        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8BC53F" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          Andamento Mensile ${year}
        </h3>
        <table>
          <thead>
            <tr><th>Mese</th><th>N° Contratti</th><th>Incasso Mese</th><th>Ricavo Totale</th></tr>
          </thead>
          <tbody>
            ${Object.values(monthlyData).map(m => `
              <tr>
                <td><strong>${m.nome}</strong></td>
                <td>${m.contratti}</td>
                <td>€ ${m.incasso.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td>€ ${m.ricavo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    });
  } catch (error) { console.error('Errore in updateAnalytics:', error); }
}

/* =========================
   Import Excel
   ========================= */
function previewExcel(event) {
  try {
    const file = event.target.files[0];
    if (!file) return;
    
    document.getElementById('fileName').textContent = file.name;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) { alert('Il file sembra vuoto'); return; }
      
      const headers = jsonData[0];
      tempImportData = jsonData.slice(1).filter(row => row.some(cell => cell)).map(row => {
        const obj = {};
        headers.forEach((h, i) => { obj[h] = row[i] || ''; });
        return obj;
      });
      
      let previewHtml = `<h3 style="margin-bottom: 15px;">Anteprima (${tempImportData.length} righe)</h3><table><thead><tr>`;
      headers.forEach(h => { previewHtml += `<th>${h}</th>`; });
      previewHtml += '</tr></thead><tbody>';
      tempImportData.slice(0, 10).forEach(row => {
        previewHtml += '<tr>';
        headers.forEach(h => { previewHtml += `<td>${row[h] || ''}</td>`; });
        previewHtml += '</tr>';
      });
      if (tempImportData.length > 10) previewHtml += `<tr><td colspan="${headers.length}" style="text-align: center; color: #6c757d;">... e altre ${tempImportData.length - 10} righe</td></tr>`;
      previewHtml += '</tbody></table>';
      
      document.getElementById('importPreview').innerHTML = previewHtml;
      document.getElementById('importPreview').style.display = 'block';
      document.getElementById('importActions').style.display = 'flex';
    };
    reader.readAsArrayBuffer(file);
  } catch (error) { console.error('Errore in previewExcel:', error); }
}

function confirmImport() {
  try {
    if (tempImportData.length === 0) { alert('Nessun dato da importare'); return; }
    
    let imported = 0;
    tempImportData.forEach(row => {
      const contract = {
        meseProduzione: row['Mese Produzione'] || row['meseProduzione'] || '',
        dataIngresso: row['Data Ingresso'] || row['dataIngresso'] || '',
        dataOrdine: row['Data Ordine'] || row['dataOrdine'] || '',
        venditore: row['Venditore'] || row['venditore'] || '',
        prodotto: row['Prodotto'] || row['prodotto'] || '',
        nomeStudente: row['Nome'] || row['nomeStudente'] || '',
        cognomeStudente: row['Cognome'] || row['cognomeStudente'] || '',
        prezzo: parseFloat(row['Prezzo'] || row['prezzo'] || 0),
        rateizzazione: row['Rateizzazione'] || row['rateizzazione'] || 'Bonifico',
        numeroContratti: parseInt(row['Numero Contratti'] || row['numeroContratti'] || 1),
        incassi: {},
        timestamp: Date.now()
      };
      
      if (contract.nomeStudente && contract.cognomeStudente) {
        database.ref('contracts').push(contract);
        imported++;
      }
    });
    
    showNotification(`Importati ${imported} contratti`);
    cancelImport();
  } catch (error) { console.error('Errore in confirmImport:', error); }
}

function cancelImport() {
  tempImportData = [];
  document.getElementById('excelFile').value = '';
  document.getElementById('fileName').textContent = '';
  document.getElementById('importPreview').style.display = 'none';
  document.getElementById('importActions').style.display = 'none';
}
    </script>
</body>
</html>
