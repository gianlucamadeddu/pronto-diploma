<script type="module">
  // Firebase v9 (Modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  // --- CONFIG FIREBASE (fornita) ---
  const firebaseConfig = {
    apiKey: "AIzaSyAKAs06_n8t19KH5CxMGisxZGM1Q5kpiU0",
    authDomain: "pronto-diploma.firebaseapp.com",
    databaseURL: "https://pronto-diploma-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "pronto-diploma",
    storageBucket: "pronto-diploma.firebasestorage.app",
    messagingSenderId: "640164355453",
    appId: "1:640164355453:web:7c79a591af4869c54f4014"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Mappe chiavi Firebase -> ID numerici locali usati dal v2.1
  const contractIdMap  = new Map();   // id numerico -> firebaseKey
  const venditoreKeyByName = new Map(); // nome -> firebaseKey

  // Utility: normalizza incassi in minuscolo
  function normalizeIncassi(incassi = {}) {
    const out = {};
    Object.entries(incassi).forEach(([k,v]) => {
      if (!v || isNaN(+v)) return;
      out[String(k).toLowerCase()] = Number(v);
    });
    return out;
  }

  // --- SYNC REALTIME: VENDITORI ---
  onValue(ref(db, 'venditori'), (snap) => {
    const data = snap.val() || {};
    // ricostruisce array globale 'venditori' del v2.1 (stesso nome/forma)
    window.venditori = [];
    venditoreKeyByName.clear();
    let autoId = 1;
    Object.entries(data).forEach(([key, v]) => {
      const attivo = v?.attivo !== false;
      const nome   = (v?.nome || '').toUpperCase();
      if (!nome) return;
      window.venditori.push({ id: autoId++, nome, attivo });
      venditoreKeyByName.set(nome, key);
    });
    // aggiorna UI come nel v2.1
    if (window.updateVenditoriSelect) window.updateVenditoriSelect();
    if (window.updateVenditoriList)  window.updateVenditoriList();
  });

  // --- SYNC REALTIME: CONTRACTS ---
  onValue(ref(db, 'contracts'), (snap) => {
    const data = snap.val() || {};
    window.contracts = [];
    contractIdMap.clear();
    let autoId = 1;

    Object.entries(data).forEach(([key, c]) => {
      const obj = {
        // campi originali del v2.1
        id: autoId++,
        meseProduzione: c?.meseProduzione || '',
        dataIngresso:   c?.dataIngresso   || '',
        dataOrdine:     c?.dataOrdine     || '',
        venditore:      (c?.venditore || '').toUpperCase(),
        prodotto:       c?.prodotto || '',
        nomeStudente:   c?.nomeStudente || '',
        cognomeStudente:c?.cognomeStudente || '',
        prezzo:         Number(c?.prezzo || 0),
        rateizzazione:  c?.rateizzazione || 'Bonifico',
        numeroContratti:parseInt(c?.numeroContratti || 1),
        incassi:        normalizeIncassi(c?.incassi),
        stornato:       !!c?.stornato,
        dataStorno:     c?.dataStorno || '',
        timestamp:      c?.timestamp || Date.now()
      };
      window.contracts.push(obj);
      contractIdMap.set(obj.id, key);
    });

    // Aggiorna viste esistenti del v2.1
    const tabContrattiAttivo = document.getElementById('contratti')?.classList.contains('active');
    const tabReportAttivo    = document.getElementById('report')?.classList.contains('active');
    if (tabContrattiAttivo && window.loadContracts) window.loadContracts();
    if (tabReportAttivo && window.updateDashboard)  window.updateDashboard();
  });

  // --- OVERRIDE FUNZIONI v2.1 -> Firebase ---

  // 1) Aggiunta venditore
  window.aggiungiVenditore = async function () {
    const input = document.getElementById('nuovoVenditore');
    const nome = (input?.value || '').trim().toUpperCase();
    if (!nome) { alert('‚ö†Ô∏è Inserisci il nome del venditore'); return; }
    if (window.venditori?.some(v => v.attivo && v.nome === nome)) {
      alert('‚ö†Ô∏è Questo venditore esiste gi√†'); return;
    }
    await set(push(ref(db, 'venditori')), { nome, attivo: true, createdAt: Date.now() });
    input.value = '';
    if (window.showNotification) window.showNotification('‚úÖ Venditore aggiunto');
  };

  // 2) Rimozione venditore (set attivo:false)
  window.rimuoviVenditore = async function (id) {
    try {
      if (!confirm('‚ö†Ô∏è Vuoi rimuovere questo venditore?')) return;
      const vend = window.venditori?.find(v => v.id === id);
      if (!vend) return;
      const key = venditoreKeyByName.get(vend.nome);
      if (!key) return;
      await update(ref(db, `venditori/${key}`), { attivo: false });
      if (window.showNotification) window.showNotification('‚úÖ Venditore rimosso');
    } catch (e) {
      console.error(e); alert('Errore rimozione venditore');
    }
  };

  // 3) Eliminazione contratto
  window.deleteContract = async function (id) {
    try {
      if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare definitivamente questo contratto?')) return;
      const key = contractIdMap.get(id);
      if (!key) return;
      await remove(ref(db, `contracts/${key}`));
      if (window.showNotification) window.showNotification('‚úÖ Contratto eliminato');
    } catch (e) {
      console.error(e); alert('Errore eliminazione contratto');
    }
  };

  // 4) Storno contratto
  window.stornaContract = async function (id) {
    try {
      if (!confirm('‚ö†Ô∏è Vuoi stornare questo contratto? Il contratto verr√† segnato come STORNATO e non verr√† pi√π conteggiato nelle statistiche.')) return;
      const key = contractIdMap.get(id);
      if (!key) return;
      const today = new Date().toISOString().split('T')[0];
      await update(ref(db, `contracts/${key}`), { stornato: true, dataStorno: today });
      if (window.showNotification) window.showNotification('‚ö†Ô∏è Contratto stornato');
    } catch (e) {
      console.error(e); alert('Errore storno contratto');
    }
  };

  // 5) Intercetta SUBMIT form contratti (scrive su Firebase, non in locale)
  (function interceptSubmit() {
    const form = document.getElementById('contractForm');
    if (!form) return;
    form.addEventListener('submit', async function (e) {
      // cattura, blocca il listener originale del v2.1
      e.preventDefault();
      e.stopImmediatePropagation();

      const btn = document.getElementById('saveBtn');
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Salvataggio...'; }

      try {
        const mesi = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
        const incassi = {};
        mesi.forEach((m) => {
          const el = document.getElementById('incasso' + m.charAt(0).toUpperCase() + m.slice(1));
          const val = el ? parseFloat(String(el.value).replace(',','.')) || 0 : 0;
          if (val > 0) incassi[m] = val;
        });

        const contract = {
          meseProduzione: document.getElementById('meseProduzione').value,
          dataIngresso:   document.getElementById('dataIngresso').value,
          dataOrdine:     document.getElementById('dataOrdine').value,
          venditore:      document.getElementById('venditore').value.toUpperCase(),
          prodotto:       document.getElementById('prodotto').value,
          nomeStudente:   document.getElementById('nomeStudente').value.trim(),
          cognomeStudente:document.getElementById('cognomeStudente').value.trim(),
          prezzo:         parseFloat(document.getElementById('prezzo').value),
          rateizzazione:  document.getElementById('rateizzazione').value,
          numeroContratti:parseInt(document.getElementById('numeroContratti').value || '1'),
          incassi,
          stornato:false,
          timestamp: Date.now()
        };

        // Validazioni base (come v2.1)
        if (!contract.meseProduzione || !contract.dataIngresso || !contract.dataOrdine ||
            !contract.venditore || !contract.prodotto || !contract.nomeStudente || !contract.cognomeStudente ||
            isNaN(contract.prezzo)) {
          alert('Compila tutti i campi obbligatori');
          if (btn) { btn.disabled = false; btn.textContent = '‚úÖ Salva Contratto'; }
          return;
        }

        await set(push(ref(db, 'contracts')), contract);

        if (window.showNotification) window.showNotification('‚úÖ Contratto salvato con successo!');
        form.reset();
        // reimposta date default
        const now = new Date();
        document.getElementById('dataIngresso').valueAsDate = now;
        document.getElementById('dataOrdine').valueAsDate   = now;
        document.getElementById('numeroContratti').value    = 1;

      } catch (error) {
        console.error(error);
        alert('Errore nel salvataggio');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = '‚úÖ Salva Contratto'; }
      }
    }, true); // <‚Äî capture: blocca il listener originale
  })();

  // 6) Import Excel: salva su Firebase, non in locale
  window.confirmImport = async function () {
    try {
      if (!Array.isArray(window.tempImportData) || window.tempImportData.length === 0) {
        alert('Nessun dato da importare'); return;
      }
      let imported = 0, skipped = 0;

      // Aggiungi venditori mancanti
      const esistenti = new Set((window.venditori || []).filter(v => v.attivo).map(v => v.nome));
      const richiesti  = new Set(window.tempImportData.map(c => (c.venditore || '').toUpperCase()).filter(Boolean));
      for (const nome of richiesti) {
        if (!esistenti.has(nome)) {
          await set(push(ref(db, 'venditori')), { nome, attivo: true, createdAt: Date.now() });
          esistenti.add(nome);
        }
      }

      // Import contratti (evita duplicati base)
      for (const c of window.tempImportData) {
        const contratto = {
          ...c,
          venditore: (c.venditore || '').toUpperCase(),
          prezzo: Number(c.prezzo || 0),
          numeroContratti: parseInt(c.numeroContratti || 1),
          incassi: normalizeIncassi(c.incassi),
          stornato: false,
          timestamp: Date.now()
        };
        // duplicate check lato client (stesso studente+mese+prezzo)
        const dup = (window.contracts || []).some(x =>
          x.nomeStudente   === contratto.nomeStudente &&
          x.cognomeStudente=== contratto.cognomeStudente &&
          x.meseProduzione === contratto.meseProduzione &&
          Number(x.prezzo) === Number(contratto.prezzo)
        );
        if (dup) { skipped++; continue; }
        await set(push(ref(db, 'contracts')), contratto);
        imported++;
      }

      // UI risultati (come v2.1)
      const statsDiv = document.getElementById('importStats');
      const resDiv   = document.getElementById('importResults');
      if (statsDiv) {
        statsDiv.innerHTML = `
          <p>‚úÖ <strong>Contratti importati:</strong> ${imported}</p>
          ${skipped ? `<p>‚ö†Ô∏è <strong>Contratti saltati (duplicati):</strong> ${skipped}</p>` : ''}
          <p>üìä <strong>Totale contratti nel sistema:</strong> ${(window.contracts||[]).length}</p>
        `;
      }
      if (resDiv) resDiv.style.display = 'block';
      const prev = document.getElementById('importPreview');
      if (prev) prev.style.display = 'none';
      const file = document.getElementById('excelFile'); if (file) file.value = '';
      window.tempImportData = [];
      if (window.showNotification) window.showNotification(`‚úÖ Importati ${imported} contratti!`);
      if (document.getElementById('contratti')?.classList.contains('active') && window.loadContracts) window.loadContracts();
    } catch (e) {
      console.error(e); alert('‚ùå Errore durante l\'importazione');
    }
  };
</script>
